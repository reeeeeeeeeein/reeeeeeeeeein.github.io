<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="SYSU 计算机专业大二在读">
<meta property="og:type" content="website">
<meta property="og:title" content="reeeeeeeeeein的博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="reeeeeeeeeein的博客">
<meta property="og:description" content="SYSU 计算机专业大二在读">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="reeeeeeeeeein">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>reeeeeeeeeein的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>


</head>

<body itemscope itemtype="http://schema.org/WebPage">
<div class="bg_content">
<canvas id="canvas"></canvas>
</div>
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">reeeeeeeeeein的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/08/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/08/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B02/" class="post-title-link" itemprop="url">安卓开发笔记2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-08 01:02:24" itemprop="dateCreated datePublished" datetime="2020-04-08T01:02:24+08:00">2020-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          # 安卓开发笔记2

~~(随手写的，不具有参考价值)~~

## Toast

Toast 是一个View视图，用于显示临时的信息，不会与用户进行交互。
它可以显示一个字符串，也可以显示一个View对象。
显示字符串时，可以在activity里调用

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Toast.makeText(getApplicationContext(),<span class="string">"要显示的字符串"</span>,Toast.LENGTH_SHORT).show();</span><br></pre></td></tr></table></figure>

第三个参数是Toast显示的时长，可以换成Toast.LENGTH_LONG，或者用数字直接指定时长，如2000指定2000ms。

显示View时，可以调用setView(view)方法，还可以用setGravity()方法来定位。

## Notification

学习这部分内容的时候遇到了各种版本不兼容的问题，暂时跳过，以后在补。

## AutoCompleteTextView

AutoCompleteTextView用于输入时的自动补全。它在xml文件中的添加方式与TextView差不多。在activity中需要为它创建一个ArrayAdapter适配器，再调用setAdapter()函数。下面是一个示例：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    AutoCompleteTextView atv;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        atv=findViewById(R.id.actv_1);</span><br><span class="line">        String [] strs=&#123;<span class="string">"abc"</span>,<span class="string">"abcd"</span>,<span class="string">"geiwj"</span>,<span class="string">"wbgoiejoje"</span>,<span class="string">"略略略略略略"</span>&#125;;</span><br><span class="line">        ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.support_simple_spinner_dropdown_item,strs);</span><br><span class="line">        atv.setAdapter(adapter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

值得注意的是在app中需要输入至少两个字母或者汉字，AutoCompleteTextView才会进行提示。
还可以在res/values中添加一个arrays.xml文件，在里面添加一些字符串内容，就不用在activity文件中定义一个String数组了。

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">"autoStrings"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>这这这<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>那那那<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>服服服<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>事实上<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>啊啊啊<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>wegnewkngeknflek<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>我我我<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

然后就可以在将adapter的定义改为

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.support_simple_spinner_dropdown_item,getResources().getStringArray(R.array.autoStrings));</span><br></pre></td></tr></table></figure>

## 对话框

对话框用于弹出一个子界面，并代替原有的界面来与用户交互。常用的对话框有提示对话框AlterDialog、进度对话框ProcessDialog、日期选择对话框DatePickerDialog和时间选择对话框TimePickerDialog等。

### 提示对话框AlterDialog

AlterDialog需要用AlterDialog.Builder来创建。一般我们定义一个AlterDialog.Builder变量，然后调用它的各种set()方法，最后调用它的show()方法显示对话框。
常用的方法有setTitle()显示标题，setMessage()方法显示内容，setNegativeButton()、setPositiveButton()和setNeutralButton()方法显示一个按钮。
一个示例程序如下：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    AutoCompleteTextView atv;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button btnstart=findViewById(R.id.bt_1);</span><br><span class="line">       btnstart.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">               AlertDialog.Builder myDialog=<span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">               myDialog.setTitle(<span class="string">"提示"</span>);</span><br><span class="line">               myDialog.setMessage(<span class="string">"这是一个AlertDialog对话框"</span>);</span><br><span class="line">               myDialog.setPositiveButton(<span class="string">"是"</span>,<span class="keyword">null</span>);</span><br><span class="line">               myDialog.setNegativeButton(<span class="string">"否"</span>,<span class="keyword">null</span>);</span><br><span class="line">               myDialog.setNeutralButton(<span class="string">"取消"</span>,<span class="keyword">null</span>);</span><br><span class="line">               myDialog.show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 进度条对话框ProgressDialog

ProgressDialog的用法与AlertDialog差不多。
用setProgressStyle()方法可以设置ProgressDialog的样式，ProgressDialog.STYLE_HORIZONTAL表示水平进度条，ProgressDialog.STYLE_SPINNER表示圆形进度条。如果希望ProgressDialog不能被取消，可以调用ProgressDialog.Cancelable(false)。
一个示例程序如下:

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Button bt_1,bt_2;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        bt_1=findViewById(R.id.bt_1);</span><br><span class="line">        bt_2=findViewById(R.id.bt_2);</span><br><span class="line">        bt_1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">               ProgressDialog progressDialog=<span class="keyword">new</span> ProgressDialog(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">               progressDialog.setTitle(<span class="string">"提示信息"</span>);</span><br><span class="line">               progressDialog.setMessage(<span class="string">"正在下载中，请稍候"</span>);</span><br><span class="line">               progressDialog.setProgressStyle(ProgressDialog.STYLE_SPINNER);</span><br><span class="line">               progressDialog.show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">        bt_2.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                ProgressDialog progressDialog=<span class="keyword">new</span> ProgressDialog(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">                progressDialog.setTitle(<span class="string">"提示信息"</span>);</span><br><span class="line">                progressDialog.setMessage(<span class="string">"正在下载中，请稍候"</span>);</span><br><span class="line">                progressDialog.setMax(<span class="number">100</span>);</span><br><span class="line">                progressDialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);</span><br><span class="line">                progressDialog.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## 列表控件ListView

ListView以列表的形式展示内容，当用户点击内容是可以进行交互。与AutoCompleteTextView一样，ListView也需要配置适配器，一般使用ArrayAdapter。ListView的列表项Item被单击会触发OnItemClick事件，被选择会触发OnItemSelect事件，我们可以定义响应两种事件的方法。
我们可以自定义Item的布局，也可以使用Android系统提供的R.layout.simple_list_item_1。
自定义时需要在layout里创建一个xml文件，示例代码如下：

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:padding</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:textSize</span>=<span class="string">"18sp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br></pre></td></tr></table></figure>

ListView的常用属性还有divider和dividerHeight,前者可以设置相邻两个列表项的分界线样式，后者可以设置分界线高度。

在activity_main.xml中可以这样添加ListView控件:

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/tv_message"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"ListView示例\n"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ListView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/listview"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"#cccccc"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ListView</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

然后可以编写MainActivity.java的代码：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ListView myListView=findViewById(R.id.listview);</span><br><span class="line">        ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.list_item,getResources().getStringArray(R.array.autoStrings));</span><br><span class="line">        myListView.setAdapter(adapter);</span><br><span class="line">        myListView.setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">                String ItemString=((TextView)view).getText().toString();</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"您单击了列表项:"</span>+ItemString,Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        myListView.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">                String ItemString=((TextView)view).getText().toString();</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"您选择了列表项:"</span>+ItemString,Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## 下拉列表Spinner

它与ListView基本一样，不再赘述。

## DatePicker

DatePicker用于让用户选择当前日期，日期范围是1900年1月1日到2100年12月31日。改变日期会触发onDateChanged事件，所以要实现DatePicker.OnDateChangedListener中的onDateChanged()方法。
在xml布局文件中定义DatePicker的方法跟其他控件基本一样，不再赘述。
示例程序如下：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DatePicker myDatePicker;</span><br><span class="line">    <span class="keyword">private</span> TextView textDate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">this</span>.setTitle(<span class="string">"日期控件的示例"</span>);</span><br><span class="line">        textDate=findViewById(R.id.tv_1);</span><br><span class="line">        myDatePicker=findViewById(R.id.dp_1);</span><br><span class="line">        Calendar calendar=Calendar.getInstance(Locale.CHINA);</span><br><span class="line">        <span class="keyword">int</span> year=calendar.get(Calendar.YEAR);</span><br><span class="line">        <span class="keyword">int</span> month=calendar.get(Calendar.MONTH);</span><br><span class="line">        <span class="keyword">int</span> day=calendar.get(Calendar.DAY_OF_MONTH);</span><br><span class="line">        myDatePicker.init(year,month,day,<span class="keyword">new</span> DatePicker.OnDateChangedListener()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDateChanged</span><span class="params">(DatePicker view,<span class="keyword">int</span> y,<span class="keyword">int</span> m,<span class="keyword">int</span> d)</span></span>&#123;</span><br><span class="line">                textDate.setText(<span class="string">"\n您选择的日期是:"</span>+y+<span class="string">"年"</span>+(m+<span class="number">1</span>)+<span class="string">"月"</span>+d+<span class="string">"日"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## TimePicker

与DatePicker基本一样，不再赘述。

## DatePickerDialog和TimePickerDialog

这两个是弹一个对话框出来,跟AlertDialog差不多。
参考程序如下:

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">this</span>.setTitle(<span class="string">"日期和时间选择对话框"</span>);</span><br><span class="line"></span><br><span class="line">        Button bt_1=findViewById(R.id.bt_1),bt_2=findViewById(R.id.bt_2);</span><br><span class="line">        bt_1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                DatePickerDialog datePickerDialog=<span class="keyword">new</span> DatePickerDialog(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">                datePickerDialog.setOnDateSetListener(<span class="keyword">new</span> DatePickerDialog.OnDateSetListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDateSet</span><span class="params">(DatePicker view, <span class="keyword">int</span> year, <span class="keyword">int</span> month, <span class="keyword">int</span> dayOfMonth)</span> </span>&#123;</span><br><span class="line">                        Toast.makeText(getApplicationContext(),<span class="string">"日期:"</span>+year+<span class="string">"-"</span>+(month+<span class="number">1</span>)+<span class="string">"-"</span>+dayOfMonth,Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                datePickerDialog.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bt_2.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                TimePickerDialog timePickerDialog=<span class="keyword">new</span> TimePickerDialog(MainActivity.<span class="keyword">this</span>, <span class="keyword">new</span> TimePickerDialog.OnTimeSetListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeSet</span><span class="params">(TimePicker view, <span class="keyword">int</span> hourOfDay, <span class="keyword">int</span> minute)</span> </span>&#123;</span><br><span class="line">                        Toast.makeText(getApplicationContext(),<span class="string">"Time: "</span>+hourOfDay+<span class="string">":"</span>+minute,Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,<span class="number">14</span>,<span class="number">55</span>,<span class="keyword">true</span>);</span><br><span class="line">                timePickerDialog.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## AnalogClock和DigitalClock

Analog用于显示模拟时钟,DigitalClock用于显示数字时钟。只需要在xml文档里声明一下即可:

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"数字时钟:"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DigitalClock</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">DigitalClock</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"模拟时钟:"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AnalogClock</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">AnalogClock</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/07/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%E7%BB%83%E4%B9%A01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/07/%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91%E7%BB%83%E4%B9%A01/" class="post-title-link" itemprop="url">安卓开发练习1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-07 20:59:42" itemprop="dateCreated datePublished" datetime="2020-04-07T20:59:42+08:00">2020-04-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          # 安卓开发练习

~~(学的很菜,不具有参考价值)~~

## 用户登录对话框

设计一个按钮，按一下弹出对话框，在对话框里用户可以输入用户名和密码，按确定后可以显示用户名和密码。

new_layout.xml文件:

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">'http://schemas.android.com/apk/res/android'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/ll_1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/et_1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"请输入你的用户名"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">EditText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/et_2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"请输入你的密码"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:inputType</span>=<span class="string">"textPassword"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">EditText</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

MainActivity文件：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> android.content.DialogInterface;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.LinearLayout;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    String yhm,mm;</span><br><span class="line">    EditText et_1,et_2;</span><br><span class="line">    TextView tv_1;</span><br><span class="line">    LinearLayout ll_1;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button btnstart=findViewById(R.id.bt_1);</span><br><span class="line">        ll_1=findViewById(R.id.ll_1);</span><br><span class="line">        tv_1=findViewById(R.id.tv_1);</span><br><span class="line">        String a=tv_1.getText().toString();</span><br><span class="line">        <span class="keyword">final</span> LayoutInflater factory = LayoutInflater.from(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">final</span> View view = factory.inflate(R.layout.new_layout, <span class="keyword">null</span>);</span><br><span class="line">        btnstart.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                AlertDialog.Builder myDialog=<span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>);</span><br><span class="line">                myDialog.setTitle(<span class="string">"提示"</span>);</span><br><span class="line">                myDialog.setMessage(<span class="string">"这是一个AlertDialog对话框"</span>);</span><br><span class="line">                myDialog.setView(view);</span><br><span class="line">                myDialog.setPositiveButton(<span class="string">"确定"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        et_1=view.findViewById(R.id.et_1);</span><br><span class="line">                        yhm=et_1.getText().toString();</span><br><span class="line">                        et_2=view.findViewById(R.id.et_2);</span><br><span class="line">                        mm=et_2.getText().toString();</span><br><span class="line">                        Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"用户名是:"</span>+yhm+<span class="string">"\n密码是:"</span>+mm,Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                myDialog.setNegativeButton(<span class="string">"取消"</span>,<span class="keyword">null</span>);</span><br><span class="line">                myDialog.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## 省市列表

第一个列表选择省份，第二个列表选择具体城市。
xml文档如下：

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"50pt"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/sp_1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Spinner</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"50pt"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/sp_2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Spinner</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

activity如下:(本来应该用setOnItemClickedListener的，但用了会闪退，并不知道为什么)。

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String myProvince,myCity;</span><br><span class="line">    <span class="keyword">private</span> Spinner sp_1,sp_2;</span><br><span class="line">    <span class="keyword">private</span> String []provinces=<span class="keyword">new</span> String[]&#123;<span class="string">"辽宁"</span>,<span class="string">"吉林"</span>,<span class="string">"黑龙江"</span>,<span class="string">"河北"</span>,<span class="string">"山西"</span>,<span class="string">"陕西"</span>,<span class="string">"甘肃"</span>,<span class="string">"青海"</span>,<span class="string">"山东"</span>,<span class="string">"安徽"</span>,<span class="string">"江苏"</span>,<span class="string">"浙江"</span>,<span class="string">"河南"</span>,<span class="string">"湖北"</span>,<span class="string">"湖南"</span>,<span class="string">"江西"</span>,<span class="string">"台湾"</span>,<span class="string">"福建"</span>,<span class="string">"云南"</span>,<span class="string">"海南"</span>,<span class="string">"四川"</span>,<span class="string">"贵州"</span>,<span class="string">"广东"</span>,<span class="string">"内蒙古"</span>,<span class="string">"新疆"</span>,<span class="string">"广西"</span>,<span class="string">"西藏"</span>,<span class="string">"宁夏"</span>,<span class="string">"北京"</span>,<span class="string">"上海"</span>,<span class="string">"天津"</span>,<span class="string">"重庆"</span>,<span class="string">"香港"</span>,<span class="string">"澳门"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String [][]cities=<span class="keyword">new</span> String[][]&#123;&#123;<span class="string">"沈阳"</span>,<span class="string">"大连"</span>,<span class="string">"鞍山"</span>,<span class="string">"抚顺"</span>,<span class="string">"本溪"</span>,<span class="string">"丹东"</span>,<span class="string">"锦州"</span>,<span class="string">"营口"</span>,<span class="string">"阜新"</span>,<span class="string">"辽阳"</span>,<span class="string">"盘锦"</span>,<span class="string">"铁岭"</span>,<span class="string">"朝阳"</span>,<span class="string">"葫芦岛"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"长春"</span>,<span class="string">"吉林"</span>,<span class="string">"四平"</span>,<span class="string">"辽源"</span>,<span class="string">"通化"</span>,<span class="string">"白山"</span>,<span class="string">"松原"</span>,<span class="string">"白城"</span>,<span class="string">"延边"</span>&#125;,&#123;<span class="string">"哈尔滨"</span>,<span class="string">"齐齐哈尔"</span>,<span class="string">"鸡西"</span>,<span class="string">"鹤岗"</span>,<span class="string">"双鸭山"</span>,<span class="string">"大庆"</span>,<span class="string">"伊春"</span>,<span class="string">"佳木斯"</span>,<span class="string">"七台河"</span>,<span class="string">"牡丹江"</span>,<span class="string">"黑河"</span>,<span class="string">"绥化"</span>,<span class="string">"大兴安岭"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"石家庄"</span>,<span class="string">"唐山"</span>,<span class="string">"秦皇岛"</span>,<span class="string">"邯郸"</span>,<span class="string">"邢台"</span>,<span class="string">"保定"</span>,<span class="string">"张家口"</span>,<span class="string">"承德"</span>,<span class="string">"沧州"</span>,<span class="string">"廊坊"</span>,<span class="string">"衡水"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"太原"</span>,<span class="string">"大同"</span>,<span class="string">"阳泉"</span>,<span class="string">"长治"</span>,<span class="string">"晋城"</span>,<span class="string">"朔州"</span>,<span class="string">"晋中"</span>,<span class="string">"运城"</span>,<span class="string">"忻州"</span>,<span class="string">"临汾"</span>,<span class="string">"吕梁"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"西安"</span>,<span class="string">"铜川"</span>,<span class="string">"宝鸡"</span>,<span class="string">"咸阳"</span>,<span class="string">"渭南"</span>,<span class="string">"延安"</span>,<span class="string">"汉中"</span>,<span class="string">"榆林"</span>,<span class="string">"安康"</span>,<span class="string">"商洛"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"兰州"</span>,<span class="string">"嘉峪关"</span>,<span class="string">"金昌"</span>,<span class="string">"白银"</span>,<span class="string">"天水"</span>,<span class="string">"武威"</span>,<span class="string">"张掖"</span>,<span class="string">"平凉"</span>,<span class="string">"酒泉"</span>,<span class="string">"庆阳"</span>,<span class="string">"定西"</span>,<span class="string">"陇南"</span>,<span class="string">"临夏"</span>,<span class="string">"甘南"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"西宁"</span>,<span class="string">"海东"</span>,<span class="string">"海北"</span>,<span class="string">"黄南"</span>,<span class="string">"海南"</span>,<span class="string">"果洛"</span>,<span class="string">"玉树"</span>,<span class="string">"海西"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"济南"</span>,<span class="string">"青岛"</span>,<span class="string">"淄博"</span>,<span class="string">"枣庄"</span>,<span class="string">"东营"</span>,<span class="string">"烟台"</span>,<span class="string">"潍坊"</span>,<span class="string">"威海"</span>,<span class="string">"济宁"</span>,<span class="string">"泰安"</span>,<span class="string">"日照"</span>,<span class="string">"莱芜"</span>,<span class="string">"临沂"</span>,<span class="string">"德州"</span>,<span class="string">"聊城"</span>,<span class="string">"滨州"</span>,<span class="string">"菏泽"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"合肥"</span>,<span class="string">"芜湖"</span>,<span class="string">"蚌埠"</span>,<span class="string">"淮南"</span>,<span class="string">"马鞍山"</span>,<span class="string">"淮北"</span>,<span class="string">"铜陵"</span>,<span class="string">"安庆"</span>,<span class="string">"黄山"</span>,<span class="string">"滁州"</span>,<span class="string">"阜阳"</span>,<span class="string">"宿州"</span>,<span class="string">"巢湖"</span>,<span class="string">"六安"</span>,<span class="string">"亳州"</span>,<span class="string">"池州"</span>,<span class="string">"宣城"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"南京"</span>,<span class="string">"无锡"</span>,<span class="string">"徐州"</span>,<span class="string">"常州"</span>,<span class="string">"苏州"</span>,<span class="string">"南通"</span>,<span class="string">"连云港"</span>,<span class="string">"淮安"</span>,<span class="string">"盐城"</span>,<span class="string">"扬州"</span>,<span class="string">"镇江"</span>,<span class="string">"泰州"</span>,<span class="string">"宿迁"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"杭州"</span>,<span class="string">"宁波"</span>,<span class="string">"温州"</span>,<span class="string">"嘉兴"</span>,<span class="string">"湖州"</span>,<span class="string">"绍兴"</span>,<span class="string">"金华"</span>,<span class="string">"衢州"</span>,<span class="string">"舟山"</span>,<span class="string">"台州"</span>,<span class="string">"丽水"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"郑州"</span>,<span class="string">"开封"</span>,<span class="string">"洛阳"</span>,<span class="string">"平顶山"</span>,<span class="string">"焦作"</span>,<span class="string">"鹤壁"</span>,<span class="string">"新乡"</span>,<span class="string">"安阳"</span>,<span class="string">"濮阳"</span>,<span class="string">"许昌"</span>,<span class="string">"漯河"</span>,<span class="string">"三门峡"</span>,<span class="string">"南阳"</span>,<span class="string">"商丘"</span>,<span class="string">"信阳"</span>,<span class="string">"周口"</span>,<span class="string">"驻马店"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"武汉"</span>,<span class="string">"黄石"</span>,<span class="string">"襄樊"</span>,<span class="string">"十堰"</span>,<span class="string">"荆州"</span>,<span class="string">"宜昌"</span>,<span class="string">"荆门"</span>,<span class="string">"鄂州"</span>,<span class="string">"孝感"</span>,<span class="string">"黄冈"</span>,<span class="string">"咸宁"</span>,<span class="string">"随州"</span>,<span class="string">"恩施"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"长沙"</span>,<span class="string">"株洲"</span>,<span class="string">"湘潭"</span>,<span class="string">"衡阳"</span>,<span class="string">"邵阳"</span>,<span class="string">"岳阳"</span>,<span class="string">"常德"</span>,<span class="string">"张家界"</span>,<span class="string">"益阳"</span>,<span class="string">"郴州"</span>,<span class="string">"永州"</span>,<span class="string">"怀化"</span>,<span class="string">"娄底"</span>,<span class="string">"湘西"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"南昌"</span>,<span class="string">"景德镇"</span>,<span class="string">"萍乡"</span>,<span class="string">"九江"</span>,<span class="string">"新余"</span>,<span class="string">"鹰潭"</span>,<span class="string">"赣州"</span>,<span class="string">"吉安"</span>,<span class="string">"宜春"</span>,<span class="string">"抚州"</span>,<span class="string">"上饶"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"台北"</span>,<span class="string">"高雄"</span>,<span class="string">"基隆"</span>,<span class="string">"台中"</span>,<span class="string">"台南"</span>,<span class="string">"新竹"</span>,<span class="string">"嘉义"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"福州"</span>,<span class="string">"厦门"</span>,<span class="string">"莆田"</span>,<span class="string">"三明"</span>,<span class="string">"泉州"</span>,<span class="string">"漳州"</span>,<span class="string">"南平"</span>,<span class="string">"龙岩"</span>,<span class="string">"宁德"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"昆明"</span>,<span class="string">"曲靖"</span>,<span class="string">"玉溪"</span>,<span class="string">"保山"</span>,<span class="string">"昭通"</span>,<span class="string">"丽江"</span>,<span class="string">"普洱"</span>,<span class="string">"临沧"</span>,<span class="string">"文山"</span>,<span class="string">"红河"</span>,<span class="string">"西双版纳"</span>,<span class="string">"楚雄"</span>,<span class="string">"大理"</span>,<span class="string">"德宏"</span>,<span class="string">"怒江"</span>,<span class="string">"迪庆"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"海口"</span>,<span class="string">"三亚"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"成都"</span>,<span class="string">"自贡"</span>,<span class="string">"攀枝花"</span>,<span class="string">"泸州"</span>,<span class="string">"德阳"</span>,<span class="string">"绵阳"</span>,<span class="string">"广元"</span>,<span class="string">"遂宁"</span>,<span class="string">"内江"</span>,<span class="string">"乐山"</span>,<span class="string">"南充"</span>,<span class="string">"宜宾"</span>,<span class="string">"广安"</span>,<span class="string">"达州"</span>,<span class="string">"眉山"</span>,<span class="string">"雅安"</span>,<span class="string">"巴中"</span>,<span class="string">"资阳"</span>,<span class="string">"阿坝"</span>,<span class="string">"凉山"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"贵阳"</span>,<span class="string">"六盘水"</span>,<span class="string">"遵义"</span>,<span class="string">"安顺"</span>,<span class="string">"铜仁"</span>,<span class="string">"毕节"</span>,<span class="string">"黔西南"</span>,<span class="string">"黔东南"</span>,<span class="string">"黔南"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"广州"</span>,<span class="string">"深圳"</span>,<span class="string">"珠海"</span>,<span class="string">"汕头"</span>,<span class="string">"韶关"</span>,<span class="string">"佛山"</span>,<span class="string">"江门"</span>,<span class="string">"湛江"</span>,<span class="string">"茂名"</span>,<span class="string">"肇庆"</span>,<span class="string">"惠州"</span>,<span class="string">"梅州"</span>,<span class="string">"汕尾"</span>,<span class="string">"河源"</span>,<span class="string">"阳江"</span>,<span class="string">"清远"</span>,<span class="string">"东莞"</span>,<span class="string">"中山"</span>,<span class="string">"潮州"</span>,<span class="string">"揭阳"</span>,<span class="string">"云浮"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"呼和浩特"</span>,<span class="string">"包头"</span>,<span class="string">"乌海"</span>,<span class="string">"赤峰"</span>,<span class="string">"通辽"</span>,<span class="string">"鄂尔多斯"</span>,<span class="string">"呼伦贝尔"</span>,<span class="string">"巴彦淖尔"</span>,<span class="string">"乌兰察布"</span>,<span class="string">"兴安"</span>,<span class="string">"锡林郭勒"</span>,<span class="string">"阿拉善"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"乌鲁木齐"</span>,<span class="string">"克拉玛依"</span>,<span class="string">"吐鲁番"</span>,<span class="string">"哈密"</span>,<span class="string">"和田"</span>,<span class="string">"阿克苏"</span>,<span class="string">"喀什"</span>,<span class="string">"克孜勒苏柯尔克孜"</span>,<span class="string">"巴音郭楞蒙古"</span>,<span class="string">"昌吉"</span>,<span class="string">"博尔塔拉蒙古"</span>,<span class="string">"伊犁哈萨克"</span>,<span class="string">"塔城"</span>,<span class="string">"阿勒泰"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"南宁"</span>,<span class="string">"柳州"</span>,<span class="string">"桂林"</span>,<span class="string">"梧州"</span>,<span class="string">"北海"</span>,<span class="string">"防城港"</span>,<span class="string">"钦州"</span>,<span class="string">"贵港"</span>,<span class="string">"玉林"</span>,<span class="string">"百色"</span>,<span class="string">"贺州"</span>,<span class="string">"河池"</span>,<span class="string">"来宾"</span>,<span class="string">"崇左"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"拉萨"</span>,<span class="string">"昌都"</span>,<span class="string">"山南"</span>,<span class="string">"那曲"</span>,<span class="string">"阿里"</span>,<span class="string">"林芝"</span>&#125;</span><br><span class="line">    ,&#123;<span class="string">"银川"</span>,<span class="string">"石嘴山"</span>,<span class="string">"吴忠"</span>,<span class="string">"固原"</span>,<span class="string">"中卫"</span>&#125;</span><br><span class="line">    ,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;&#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        sp_1=findViewById(R.id.sp_1);</span><br><span class="line">        sp_2=findViewById(R.id.sp_2);</span><br><span class="line">        ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.support_simple_spinner_dropdown_item,provinces);</span><br><span class="line">        sp_1.setAdapter(adapter);</span><br><span class="line">        sp_1.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">                ArrayAdapter&lt;String&gt;adapterr=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(MainActivity.<span class="keyword">this</span>,R.layout.list_item,cities[position]);</span><br><span class="line">                sp_2.setAdapter(adapterr);</span><br><span class="line">                myProvince=((TextView)view).getText().toString();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        sp_2.setOnItemSelectedListener(<span class="keyword">new</span> AdapterView.OnItemSelectedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">                myCity=((TextView)view).getText().toString();</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"你选择了: "</span>+myProvince+<span class="string">"省"</span>+myCity+<span class="string">"市"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNothingSelected</span><span class="params">(AdapterView&lt;?&gt; parent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

## 动态下拉列表

用一个EditText来跟用户交互。用户按下"添加"按钮就把EditText的内容添加到下拉列表里，按下"删除"按钮就降下拉列表里EditText的内容删除(如果有的话)。
xml文档如下:

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/et_1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"请输入…"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">EditText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spinner</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/sp_1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Spinner</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/bt_1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"添加"</span>&gt;</span><span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/bt_2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"删除"</span>&gt;</span><span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

activity_main文件如下:

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Button bt_1,bt_2;</span><br><span class="line">    <span class="keyword">private</span> EditText et_1;</span><br><span class="line">    <span class="keyword">private</span> Spinner sp_1;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;String&gt; strings;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        et_1=findViewById(R.id.et_1);</span><br><span class="line">        bt_1=findViewById(R.id.bt_1);</span><br><span class="line">        bt_2=findViewById(R.id.bt_2);</span><br><span class="line">        sp_1=findViewById(R.id.sp_1);</span><br><span class="line">        strings=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        bt_1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                String tem=et_1.getText().toString();</span><br><span class="line">                strings.add(tem);</span><br><span class="line">                ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(MainActivity.<span class="keyword">this</span>,R.layout.support_simple_spinner_dropdown_item,strings);</span><br><span class="line">                sp_1.setAdapter(adapter);</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"添加成功!"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bt_2.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                String tem=et_1.getText().toString();</span><br><span class="line">                <span class="keyword">if</span>(strings.contains(tem))&#123;</span><br><span class="line">                    strings.remove(tem);</span><br><span class="line">                    ArrayAdapter&lt;String&gt;adapter=<span class="keyword">new</span> ArrayAdapter&lt;String&gt;(MainActivity.<span class="keyword">this</span>,R.layout.support_simple_spinner_dropdown_item,strings);</span><br><span class="line">                    sp_1.setAdapter(adapter);</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"删除成功!"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"删除失败!"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/04/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E4%BD%9C%E4%B8%9A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/04/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E4%BD%9C%E4%B8%9A2/" class="post-title-link" itemprop="url">并行与分布式计算作业2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-04 21:35:37" itemprop="dateCreated datePublished" datetime="2020-04-04T21:35:37+08:00">2020-04-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          # 并行与分布式计算作业2

| 姓名    |   学号  |   班级 | 邮箱 |
-------- | -------| ---| ------ |
| 张景润 |  18340210 | 计科八班| zhangjr35@mail2.sysu.edu.cn |

## 第一题

### 题目

&#8195;&#8195;分别采用不同的算法（非分布式算法）例如一般算法、分治算法和Strassen算法等计算计 算矩阵两个300x300的矩阵乘积，并通过Perf工具分别观察cache miss、CPI、 mem_load 等性能指标。

### 解答

#### 一般算法

&#8195;&#8195;编写一个矩阵乘法程序，代码如下:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_OF_MATRIX 300</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">matrix</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> n,m;</span><br><span class="line">  <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; vec;</span><br><span class="line">  matrix(<span class="keyword">int</span> nn=<span class="number">0</span>,<span class="keyword">int</span> mm=<span class="number">0</span>):n(nn),m(mm)&#123;</span><br><span class="line">    vec=<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; (n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)vec[i]=<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; (m);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">get_rand</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)vec[i][j]=(<span class="keyword">double</span>)rand()/(INT_MAX);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)<span class="built_in">cout</span>&lt;&lt;vec[i][j]&lt;&lt;<span class="string">" "</span>;</span><br><span class="line">      <span class="built_in">cout</span>&lt;&lt;<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  matrix <span class="keyword">operator</span> *(matrix b)&#123;</span><br><span class="line">    <span class="keyword">if</span>(m!=b.n)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,b.m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;m;k++)&#123;</span><br><span class="line">          ret.vec[i][j]+=vec[i][k]*b.vec[k][j];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="comment">//cout&lt;&lt;"Hello world\n";</span></span><br><span class="line">  matrix a(SIZE_OF_MATRIX,SIZE_OF_MATRIX),b(SIZE_OF_MATRIX,SIZE_OF_MATRIX);</span><br><span class="line">  a.get_rand(),b.get_rand();</span><br><span class="line">  <span class="comment">//a.output(),b.output();</span></span><br><span class="line">  </span><br><span class="line">  matrix c=a*b;</span><br><span class="line">  <span class="comment">//c.output();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

&#8195;&#8195;使用perf观察 cache-misses,cpi,mem-loads 等性能指标:

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf <span class="built_in">stat</span> -e cache-misses,instructions,cycles,mem-loads -r 10  ./a</span><br></pre></td></tr></table></figure>

结果如下：
![image.png](https://i.loli.net/2020/03/30/YGRbAyPqlkmzEfM.png)
&#8195;&#8195;可以看到,10次运行的平均cache-misses次数只有38100次，相比于3e9级别的指令数量，这个数字还是比较少的。
&#8195;&#8195;平均指令数为3,373,445,889，平均cpu cycles只有 1,189,821,710，计算得$$CPI=\frac{1,189,821,710}{3,373,445,889}\approx0.3527$$这是一个小于1的数字，十分奇怪，我推测是编译器或者是CPU在底层对循环进行了并行优化。
&#8195;&#8195;而mem_loads为0，这也十分奇怪，大概是perf出了什么bug。
&#8195;&#8195;用perf record 对cache-misses 和 instructions的分布进行详细分析:

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf record -e cache-misses,instructions -g ./a</span><br></pre></td></tr></table></figure>

结果如下：
![N7C_FJC~_W7KBF080VFUQHO.png](https://i.loli.net/2020/03/30/SdRMi4Lk7hbqaAl.png)

![57UDL_OJL_`3HPY1F0ND3ZS.png](https://i.loli.net/2020/03/30/Hhj6YGoLQwitACD.png)
&#8195;&#8195;可以看到，矩阵乘法阶段占用instructions的比例较高，发生的cache-misses次数也较多。

#### 分治算法

&#8195;&#8195;这里的分治算法是利用矩阵分块将矩阵分为4个子矩阵，这样就可以对两个二乘二的矩阵进行乘法，最后再合并起来得到结果。简单的分治算法的时间复杂度仍然是$O(n^3)$的。
代码如下：

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_OF_MATRIX 300</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps=<span class="number">1e-6</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">matrix</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> n,m;</span><br><span class="line">  <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; vec;</span><br><span class="line">  matrix(<span class="keyword">int</span> nn=<span class="number">0</span>,<span class="keyword">int</span> mm=<span class="number">0</span>):n(nn),m(mm)&#123;</span><br><span class="line">    vec=<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; (n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)vec[i]=<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; (m);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">get_rand</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)vec[i][j]=(<span class="keyword">double</span>)rand()/(INT_MAX);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)<span class="built_in">cout</span>&lt;&lt;vec[i][j]&lt;&lt;<span class="string">" "</span>;</span><br><span class="line">      <span class="built_in">cout</span>&lt;&lt;<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  matrix <span class="keyword">operator</span> *(matrix &amp;b)&#123;</span><br><span class="line">    <span class="keyword">if</span>(m!=b.n)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,b.m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;m;k++)&#123;</span><br><span class="line">          ret.vec[i][j]+=vec[i][k]*b.vec[k][j];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  matrix <span class="keyword">operator</span>+(<span class="keyword">const</span> matrix&amp; b)&#123;</span><br><span class="line">    <span class="keyword">if</span>(n!=b.n&amp;&amp;m!=b.m)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        ret.vec[i][j]=vec[i][j]+b.vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="built_in">vector</span>&lt;matrix&gt; <span class="title">divide</span><span class="params">()</span></span>&#123;</span><br><span class="line">    matrix m1(n/2,m/2),m2(n/2,m-m/2),m3(n-n/2,m/2),m4(n-n/2,m-m/2);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m1.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m1.m;j++)&#123;</span><br><span class="line">        m1.vec[i][j]=vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m2.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m2.m;j++)&#123;</span><br><span class="line">        m2.vec[i][j]=vec[i][j+m1.m];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m3.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m3.m;j++)&#123;</span><br><span class="line">        m3.vec[i][j]=vec[i+m1.n][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m4.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m4.m;j++)&#123;</span><br><span class="line">        m4.vec[i][j]=vec[i+m1.n][j+m1.m];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">vector</span>&lt;matrix&gt;&#123;m1,m2,m3,m4&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function">matrix <span class="title">merge</span><span class="params">(<span class="built_in">vector</span>&lt;matrix&gt; &amp;matrices)</span></span>&#123;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(matrices[<span class="number">0</span>].n+matrices[<span class="number">3</span>].n,matrices[<span class="number">0</span>].m+matrices[<span class="number">3</span>].m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">0</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">0</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i][j]=matrices[<span class="number">0</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">1</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">1</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i][j+matrices[<span class="number">0</span>].m]=matrices[<span class="number">1</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">2</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">2</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i+matrices[<span class="number">0</span>].n][j]=matrices[<span class="number">2</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">3</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">3</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i+matrices[<span class="number">0</span>].n][j+matrices[<span class="number">0</span>].m]=matrices[<span class="number">3</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">matrix <span class="title">divide_conquer</span><span class="params">(matrix &amp;a,matrix &amp;b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(a.n&lt;<span class="number">10</span>)<span class="keyword">return</span> a*b;</span><br><span class="line">    <span class="built_in">vector</span>&lt;matrix&gt; vec1=a.divide(),vec2=b.divide();</span><br><span class="line"><span class="comment">//    cout&lt;&lt;vec1[0].n&lt;&lt;" "&lt;&lt;vec2[3].m&lt;&lt;endl;</span></span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;matrix&gt; <span class="title">sub_matrix</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line">    sub_matrix[<span class="number">0</span>]=divide_conquer(vec1[<span class="number">0</span>],vec2[<span class="number">0</span>])+divide_conquer(vec1[<span class="number">1</span>],vec2[<span class="number">2</span>]);</span><br><span class="line">    sub_matrix[<span class="number">1</span>]=divide_conquer(vec1[<span class="number">0</span>],vec2[<span class="number">1</span>])+divide_conquer(vec1[<span class="number">1</span>],vec2[<span class="number">3</span>]);</span><br><span class="line">    sub_matrix[<span class="number">2</span>]=divide_conquer(vec1[<span class="number">2</span>],vec2[<span class="number">0</span>])+divide_conquer(vec1[<span class="number">3</span>],vec2[<span class="number">2</span>]);</span><br><span class="line">    sub_matrix[<span class="number">3</span>]=divide_conquer(vec1[<span class="number">2</span>],vec2[<span class="number">1</span>])+divide_conquer(vec1[<span class="number">3</span>],vec2[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">return</span> merge(sub_matrix);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="comment">//cout&lt;&lt;"Hello world\n";</span></span><br><span class="line">  matrix a(SIZE_OF_MATRIX,SIZE_OF_MATRIX),b(SIZE_OF_MATRIX,SIZE_OF_MATRIX);</span><br><span class="line">  a.get_rand(),b.get_rand();</span><br><span class="line">  <span class="comment">//a.output(),b.output();</span></span><br><span class="line">  matrix c=divide_conquer(a,b);</span><br><span class="line">  <span class="comment">//matrix d=a*b;</span></span><br><span class="line">  <span class="keyword">bool</span> ok=<span class="literal">true</span>;</span><br><span class="line">  <span class="comment">/*for(int i=0;i&lt;SIZE_OF_MATRIX;i++)&#123;</span></span><br><span class="line"><span class="comment">    for(int j=0;j&lt;SIZE_OF_MATRIX;j++)if(abs(c.vec[i][j]-d.vec[i][j])&gt;eps)ok=false;//cout&lt;&lt;i&lt;&lt;" "&lt;&lt;j&lt;&lt;" "&lt;&lt;c.vec[i][j]&lt;&lt;" "&lt;&lt;d.vec[i][j]&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">  cout&lt;&lt;ok&lt;&lt;endl;*/</span></span><br><span class="line"><span class="comment">//  c.output();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

&#8195;&#8195;同样是使用

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf <span class="built_in">stat</span> -e cache-misses,instructions,cycles,mem-loads -r 10  ./a</span><br></pre></td></tr></table></figure>

&#8195;&#8195;来对性能进行分析，结果如下图所示：
![image.png](https://i.loli.net/2020/03/30/ewKDWIO6qu2vjCM.png)

&#8195;&#8195;可以看到cache-misses次数与之前基本一样；CPI升高到了0.5208，仍然小于1，说明底层的并行化效果不错；而mem-loads仍然为0。
&#8195;&#8195;平均时间消耗达到了将近3秒，是之前的4倍还要多，说明程序在递归调用时消耗了大量时间。

#### strassen算法

&#8195;&#8195;strassen算法用很神奇的方法把矩阵乘法的时间复杂度降低到了$O(n^{2.81})$左右,在矩阵规模较大的情况下性能会更好。
&#8195;&#8195;代码如下:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_OF_MATRIX 300</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> eps=<span class="number">1e-6</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">matrix</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> n,m;</span><br><span class="line">  <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; vec;</span><br><span class="line">  matrix(<span class="keyword">int</span> nn=<span class="number">0</span>,<span class="keyword">int</span> mm=<span class="number">0</span>):n(nn),m(mm)&#123;</span><br><span class="line">    vec=<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; &gt; (n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)vec[i]=<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; (m);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">get_rand</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)vec[i][j]=(<span class="keyword">double</span>)rand()/(INT_MAX);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m;j++)<span class="built_in">cout</span>&lt;&lt;vec[i][j]&lt;&lt;<span class="string">" "</span>;</span><br><span class="line">      <span class="built_in">cout</span>&lt;&lt;<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  matrix <span class="keyword">operator</span> *(<span class="keyword">const</span> matrix &amp;b)<span class="keyword">const</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m!=b.n)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,b.m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;m;k++)&#123;</span><br><span class="line">          ret.vec[i][j]+=vec[i][k]*b.vec[k][j];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  matrix <span class="keyword">operator</span>+(<span class="keyword">const</span> matrix&amp; b)<span class="keyword">const</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n!=b.n&amp;&amp;m!=b.m)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        ret.vec[i][j]=vec[i][j]+b.vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  matrix <span class="keyword">operator</span>-(<span class="keyword">const</span> matrix&amp; b)<span class="keyword">const</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n!=b.n&amp;&amp;m!=b.m)&#123;</span><br><span class="line">      <span class="keyword">return</span> matrix();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(n,m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;ret.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;ret.m;j++)&#123;</span><br><span class="line">        ret.vec[i][j]=vec[i][j]-b.vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="built_in">vector</span>&lt;matrix&gt; <span class="title">divide</span><span class="params">()</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">    matrix m1(n/2,m/2),m2(n/2,m-m/2),m3(n-n/2,m/2),m4(n-n/2,m-m/2);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m1.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m1.m;j++)&#123;</span><br><span class="line">        m1.vec[i][j]=vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m2.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m2.m;j++)&#123;</span><br><span class="line">        m2.vec[i][j]=vec[i][j+m1.m];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m3.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m3.m;j++)&#123;</span><br><span class="line">        m3.vec[i][j]=vec[i+m1.n][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;m4.n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;m4.m;j++)&#123;</span><br><span class="line">        m4.vec[i][j]=vec[i+m1.n][j+m1.m];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">vector</span>&lt;matrix&gt;&#123;m1,m2,m3,m4&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function">matrix <span class="title">merge</span><span class="params">(<span class="built_in">vector</span>&lt;matrix&gt; &amp;matrices)</span></span>&#123;</span><br><span class="line">    <span class="function">matrix <span class="title">ret</span><span class="params">(matrices[<span class="number">0</span>].n+matrices[<span class="number">3</span>].n,matrices[<span class="number">0</span>].m+matrices[<span class="number">3</span>].m)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">0</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">0</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i][j]=matrices[<span class="number">0</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">1</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">1</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i][j+matrices[<span class="number">0</span>].m]=matrices[<span class="number">1</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">2</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">2</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i+matrices[<span class="number">0</span>].n][j]=matrices[<span class="number">2</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;matrices[<span class="number">3</span>].n;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;matrices[<span class="number">3</span>].m;j++)&#123;</span><br><span class="line">        ret.vec[i+matrices[<span class="number">0</span>].n][j+matrices[<span class="number">0</span>].m]=matrices[<span class="number">3</span>].vec[i][j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">matrix <span class="title">strassen</span><span class="params">(matrix a,matrix b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(a.n&lt;=<span class="number">75</span>)<span class="keyword">return</span> a*b;</span><br><span class="line">    <span class="keyword">if</span>(a.n&amp;<span class="number">1</span>)&#123;</span><br><span class="line">      a.vec.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt;(a.m));</span><br><span class="line">      b.vec.push_back(<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt;(b.m));</span><br><span class="line">      a.n++,b.n++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(a.m&amp;<span class="number">1</span>)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">auto</span> i:a.vec)i.push_back(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">auto</span> i:b.vec)i.push_back(<span class="number">0</span>);</span><br><span class="line">      a.m++,b.m++;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    cout&lt;&lt;a.n&lt;&lt;" "&lt;&lt;a.m&lt;&lt;" "&lt;&lt;b.n&lt;&lt;" "&lt;&lt;b.m;</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;matrix&gt; vec1=a.divide(),vec2=b.divide();</span><br><span class="line"><span class="comment">//    cout&lt;&lt;vec1[0].n&lt;&lt;" "&lt;&lt;vec2[3].m&lt;&lt;endl;</span></span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;matrix&gt; <span class="title">m</span><span class="params">(<span class="number">7</span>)</span></span>;</span><br><span class="line">    m[<span class="number">0</span>]=strassen((vec1[<span class="number">0</span>]+vec1[<span class="number">3</span>]),(vec2[<span class="number">0</span>]+vec2[<span class="number">3</span>]));</span><br><span class="line">    m[<span class="number">1</span>]=strassen((vec1[<span class="number">2</span>]+vec1[<span class="number">3</span>]),vec2[<span class="number">0</span>]);</span><br><span class="line">    m[<span class="number">2</span>]=strassen(vec1[<span class="number">0</span>],(vec2[<span class="number">1</span>]-vec2[<span class="number">3</span>]));</span><br><span class="line">    m[<span class="number">3</span>]=strassen(vec1[<span class="number">3</span>],(vec2[<span class="number">2</span>]-vec2[<span class="number">0</span>]));</span><br><span class="line">    m[<span class="number">4</span>]=strassen((vec1[<span class="number">0</span>]+vec1[<span class="number">1</span>]),vec2[<span class="number">3</span>]);</span><br><span class="line">    m[<span class="number">5</span>]=strassen((vec1[<span class="number">2</span>]-vec1[<span class="number">0</span>]),(vec2[<span class="number">0</span>]+vec2[<span class="number">1</span>]));</span><br><span class="line">    m[<span class="number">6</span>]=strassen((vec1[<span class="number">1</span>]-vec1[<span class="number">3</span>]),(vec2[<span class="number">2</span>]+vec2[<span class="number">3</span>]));</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;matrix&gt; <span class="title">mm</span><span class="params">(&#123;m[<span class="number">0</span>]+m[<span class="number">3</span>]-m[<span class="number">4</span>]+m[<span class="number">6</span>],m[<span class="number">2</span>]+m[<span class="number">4</span>],m[<span class="number">1</span>]+m[<span class="number">3</span>],m[<span class="number">0</span>]+m[<span class="number">2</span>]-m[<span class="number">1</span>]+m[<span class="number">5</span>]&#125;)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> merge(mm);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="comment">//cout&lt;&lt;"Hello world\n";</span></span><br><span class="line">  matrix a(SIZE_OF_MATRIX,SIZE_OF_MATRIX),b(SIZE_OF_MATRIX,SIZE_OF_MATRIX);</span><br><span class="line">  a.get_rand(),b.get_rand();</span><br><span class="line">  <span class="comment">//a.output(),b.output();</span></span><br><span class="line">  </span><br><span class="line">  matrix c=strassen(a,b);</span><br><span class="line">  <span class="comment">/*matrix d=a*b;</span></span><br><span class="line"><span class="comment">  bool ok=true;</span></span><br><span class="line"><span class="comment">  for(int i=0;i&lt;SIZE_OF_MATRIX;i++)&#123;</span></span><br><span class="line"><span class="comment">    for(int j=0;j&lt;SIZE_OF_MATRIX;j++)if(abs(c.vec[i][j]-d.vec[i][j])&gt;eps)ok=false,cout&lt;&lt;i&lt;&lt;" "&lt;&lt;j&lt;&lt;" "&lt;&lt;c.vec[i][j]&lt;&lt;" "&lt;&lt;d.vec[i][j]&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">  &#125;*/</span></span><br><span class="line"><span class="comment">//  c.output();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

&#8195;&#8195;考虑到函数调用会产生大量性能损失，我在strassen函数里设置了一个常量，当矩阵大小小于等于这个量时使用普通的矩阵乘法。
&#8195;&#8195;对这个常量值为40,75,150(对应进行三层递归，两层递归，一层递归)分别进行了测试，运行效果如下：

![image.png](https://i.loli.net/2020/03/31/2iUzk4M1wdLNgQa.png)

![image.png](https://i.loli.net/2020/03/31/q4Hm1AJgVjOcaZ5.png)
![image.png](https://i.loli.net/2020/03/31/lfOq56AnPWUJNgV.png)
&#8195;&#8195;实验证明，进行两层递归的效果最好，为0.52秒左右，比直接计算有稍微的提高。
&#8195;&#8195;同样是使用

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf <span class="built_in">stat</span> -e cache-misses,instructions,cycles,mem-loads -r 10  ./a</span><br></pre></td></tr></table></figure>

&#8195;&#8195;来对性能进行分析，结果如下图所示：
![image.png](https://i.loli.net/2020/03/31/scpDBqOVY5iPkIL.png)
&#8195;&#8195;cache-misses次数较多，CPI是0.347，比之前有所降低。

## 第二题

本来是打算做一下的，但没装双系统，只有一个linux服务器，又没有管理员权限，只能放弃了。

## 第三题

### 题目

&#8195;&#8195;Consider a memory system with a level 1 cache of 32 KB and DRAM of 512 MB with the processor operating at 1 GHz. The latency to L1 cache is one cycle and the latency to DRAM is 100 cycles. In each memory cycle, the processor fetches four words (cache line size is four words). What is the peak achievable performance of a dot product of two vectors? Note: Where necessary, assume an optimal cache placement policy.

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line">dot_prod += a[i] * b[i];</span><br></pre></td></tr></table></figure>

### 解答

&#8195;&#8195;在这里我假设数组的元素都是4字节的float类型，一个word是4个字节，cache分配时不会把上一次刚分配的块覆盖掉，i,dot_prod两个变量放在寄存器里。
&#8195;&#8195;则对每一次循环：
&#8195;&#8195;①如果i%4==0，则读取a[i]时需要从内存中取出a[i],a[i+1],a[i+2],a[i+3]放在cache里，需要100ns，读取b[i]时需要从内存中取出b[i],b[i+1],b[i+2],b[i+3]放在cache里，需要100ns。则这次循环需要 100ns+100ns+4ns(比较i与dim要1ns,i++要1ns,a[i]*b[i]要1ns，将结果加到dot_prod要1ns)，共204ns。
&#8195;&#8195;②如果i%4！=0，则a[i],b[i]可以从cache里取出，需要2ns。则这次循环需要 2ns+2ns+4ns，共8ns。
&#8195;&#8195;所以，每次循环平均需要 $\frac{3*8+204}{4}=57ns$故每秒钟能进行17.5M次循环。考虑到每次循环是进行了两次浮点数运算，所以能达到的最高性能是35MFLOPS

## 第四题

### 题目

&#8195;&#8195;Now consider the problem of multiplying a dense matrix with a vector using a two-loop dot-product formulation. The matrix is of dimension 4K x 4K. (Each row of the matrix takes 16 KB of storage.) What is the peak achievable performance of this technique using a twoloop dot-product based matrix-vector product.

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; dim; i++)</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dim; j++)</span><br><span class="line">c[i] += a[i][j] * b[j];</span><br></pre></td></tr></table></figure>

### 解答

&#8195;&#8195;我们仍然假设cache不会把刚刚分配的块覆盖掉，在取a[i][j]时只需访问一次内存\cache，i和j两个变量放在寄存器里，且i<dim，i++这两个操作可以忽略不计。值得注意的是cache的大小为32k，而b数组大小为16k，矩阵a的一行也是16k，如果cache分配策略是最优的，则b数组会在i=0时全部装进cache里，只有a数组需要重复取出，所以在内存里取出b数组的时间也可以忽略。
&#8195;&#8195;则对每一次循环：
&#8195;&#8195;①如果j%4==0，则读取a[i][j]时需要从内存中取出a[i][j],a[i][j+1],a[i][j+2],a[i][j+3]放在cache里，需要100ns。c[i]只有一开始会从内存中取到cache里(这一次的用时也忽略不计)，之后一直在寄存器里放着。
则这次循环需要 100ns+5ns(假设比较j与dim要1ns,j++要1ns,a[i][j]*b[j]要1ns，取出c[i]要2ns，将结果加到c[i]要1ns)，共106ns。
&#8195;&#8195;②如果i%4！=0，则a[i][j],b[j]可以从cache里取出，需要2ns。则这次循环需要 2ns+2ns+6ns，共10ns。
&#8195;&#8195;所以，每次循环平均需要 $\frac{3*10+106}{4}=34ns$,每秒钟能执行29.4M次循环，能达到的最高性能是59.8MFLOPS。

## 总结

&#8195;&#8195;这次实验还是很有难度的。使用perf需要在linux系统，而我只有一个WSL,用不了perf，于是只能找人借了个linux服务器账号。好不容易完成了第一问，去钻研第二问的时候又遇到了很多不会的知识。折腾一番后总算明白要用到linux内核，但我没有管理员权限，用不了，只得作罢。虽然没能把第二问做出来，但多多少少还是有点收获。
&#8195;&#8195;做到后面的时候发现第一问的矩阵乘法还有很多可以优化的地方，如vector改为数组、把数组改为指针等，但时间有限就没有修改了。
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/16/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E7%AC%94%E8%AE%B02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/16/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E7%AC%94%E8%AE%B02/" class="post-title-link" itemprop="url">并行与分布式计算笔记2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-16 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-16T00:00:00+08:00">2020-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-17 17:29:33" itemprop="dateModified" datetime="2020-03-17T17:29:33+08:00">2020-03-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
# 并行与分布式计算笔记2


主函数之外的变量是全局的，被所有线程共享，一般用于通信。
在堆上申请的，可能是共享的。
栈上的变量一般是私有的，只有某个线程能够使用。

线程是有限的，如果创建的线程太多，对操作系统而言是个灾难。
创建一个线程大概要1e4个cpu时钟，线程间切换大概要1e3个cpu时钟。

线程的调度取决于:
操作系统的硬件，如果线程太多会执行不过来。
调度器的设计。
程序员的干预，可以设定线程跑在哪个CPU核心。

有一些硬件本身支持多线程，线程间切换会快很多，大概10左右cpu时钟。
线程切换:
执行一定指令后切换(细粒度)
当线程遇到需要花很多时间的操作如cache miss切换，线程会off-cpu。‘；(粗粒度)

将ILP和TLP结合
TLP是将几个指令流同时进行，可以把这里的指令换成ILP的指令。
这种方法称为同时多线程(Simultaneous Multi-threading),Intel称之为超线程。

内存系统的latency和bandwidth
latency是请求的发出到返回的时间。
bandwidth是单位时间内能从内存中取出的数据量。
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/12/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E4%BD%9C%E4%B8%9A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/12/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E4%BD%9C%E4%B8%9A1/" class="post-title-link" itemprop="url">并行与分布式计算作业1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-12 22:42:47" itemprop="dateCreated datePublished" datetime="2020-03-12T22:42:47+08:00">2020-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          # 并行与分布式计算作业1

## 作业题目

现代处理器如Intel、ARM、AMD、Power以及国产CPU如华为鲲鹏等，均包含了并行指令集合，① 请调查这些处理器中的并行指 令集，并选择其中一种进行编程练习，计算两个各包含10^6个整数的向量之和。 此外，② 现代操作系统为了发挥多核的优势，支持多线程并行编程模型，请将问题①用多线程的方式实现，线程实现的语言不限，可以是Java，也可以是 C/C++。

## 用串行的方法完成向量之和计算

为了进行对照，先写一个串行的程序：

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Size 1000000</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a[Size],b[Size],c[Size];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>,<span class="title">tv2</span>;</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Size;i++)c[i]=a[i]+b[i];</span><br><span class="line">    gettimeofday(&amp;tv2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"time: %d\n"</span>,tv2.tv_sec*<span class="number">1000000</span> + tv2.tv_usec - tv.tv_sec*<span class="number">1000000</span> - tv.tv_usec);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

进行了5次实验，结果如下：
![image.png](https://i.loli.net/2020/03/02/ftERVcS28Zq1O5h.png)
平均耗时：3,276.2μs

## 用并行指令集axv来完成向量之和计算

首先在<https://github.com/chen0031/AVX-AVX2-Example-Code>中下载文件夹，在wsl中cd进入文件夹，即可用make命令进行编译，用make run命令运行。

![image.png](https://i.loli.net/2020/03/02/d2uWqbMJlsU5T6P.png)

![image.png](https://i.loli.net/2020/03/02/a4PGxXndvMmhOpg.png)

然后执行 cd ./Arithmetic_Intrinsics/src，将其中的add.c文件修改为：

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author:  TripleZ&lt;me@triplez.cn&gt;</span></span><br><span class="line"><span class="comment"> * Date:    2018-08-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Size 1000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;immintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line">__m256i my_int_vec_0[Size/<span class="number">8</span>+<span class="number">3</span>];<span class="comment">//数组每个元素存8个整数，故数组的大小为Size/8,+3是为了防止越界</span></span><br><span class="line">__m256i my_int_vec_1[Size/<span class="number">8</span>+<span class="number">3</span>];</span><br><span class="line">__m256i my_int_result[Size/<span class="number">8</span>+<span class="number">3</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Size/<span class="number">8</span>;i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">        my_int_vec_0[i][j]=rand();</span><br><span class="line">        my_int_vec_1[i][j]=rand();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>,<span class="title">tv2</span>;</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Size/<span class="number">8</span>;i++)&#123;</span><br><span class="line">      my_int_result[i]=_mm256_add_epi32(my_int_vec_0[i],my_int_vec_1[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday(&amp;tv2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n\n\n\n\n\ntime: %dμs\n\n\n\n\n\n"</span>,tv2.tv_sec*<span class="number">1000000</span> + tv2.tv_usec - tv.tv_sec*<span class="number">1000000</span> - tv.tv_usec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

即可进行计算。

分别进行5次实验，耗时分别为(单位为μs)：
1491，1329，1178，2009，1470
平均耗时：1,495.4μs
可以发现，用并行指令集进行计算会快很多，加速比大概是2.19

## 用多线程来完成向量之和计算

使用mpi来实现多线程完成向量之和，代码如下：

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_size 10000000</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> a[MAX_size], b[MAX_size], c[MAX_size];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//cout&lt;&lt;"???\n";</span></span><br><span class="line">  <span class="keyword">int</span> numprocs, myid, source;</span><br><span class="line">  MPI_Status status;</span><br><span class="line">  MPI_Init(&amp;argc, &amp;argv);</span><br><span class="line">  MPI_Comm_rank(MPI_COMM_WORLD, &amp;myid);</span><br><span class="line">  MPI_Comm_size(MPI_COMM_WORLD, &amp;numprocs);</span><br><span class="line">  <span class="keyword">int</span> sub_size=MAX_size / (numprocs - <span class="number">1</span>);</span><br><span class="line"><span class="comment">//  cout&lt;&lt;"???\n";</span></span><br><span class="line">  <span class="keyword">if</span> (myid == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>,<span class="title">tv2</span>;</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//cout&lt;&lt;"???\n";</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numprocs; i++)</span><br><span class="line">    &#123;</span><br><span class="line">      MPI_Send(a + (i - <span class="number">1</span>) * sub_size, sub_size,</span><br><span class="line">               MPI_INT, i, i, MPI_COMM_WORLD);</span><br><span class="line">      MPI_Send(b + (i - <span class="number">1</span>) * sub_size, sub_size,</span><br><span class="line">               MPI_INT, i, i, MPI_COMM_WORLD);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//  cout&lt;&lt;"???\n";</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numprocs; i++)</span><br><span class="line">    &#123;</span><br><span class="line">      MPI_Recv(c + (i - <span class="number">1</span>) * sub_size, sub_size,</span><br><span class="line">               MPI_INT, i, i, MPI_COMM_WORLD, &amp;status);</span><br><span class="line">    &#125;</span><br><span class="line">    gettimeofday(&amp;tv2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"time: %d\n"</span>,tv2.tv_sec*<span class="number">1000000</span> + tv2.tv_usec - tv.tv_sec*<span class="number">1000000</span> - tv.tv_usec);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">int</span> *tema = <span class="keyword">new</span> <span class="keyword">int</span>[sub_size];</span><br><span class="line">    <span class="keyword">int</span> *temb = <span class="keyword">new</span> <span class="keyword">int</span>[sub_size];</span><br><span class="line">    <span class="keyword">int</span> *temc = <span class="keyword">new</span> <span class="keyword">int</span>[sub_size];</span><br><span class="line">    MPI_Recv(tema, sub_size,</span><br><span class="line">             MPI_INT, <span class="number">0</span>, myid, MPI_COMM_WORLD, &amp;status);</span><br><span class="line">    MPI_Recv(temb, sub_size,</span><br><span class="line">            MPI_INT, <span class="number">0</span>, myid, MPI_COMM_WORLD,&amp;status);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;sub_size;i++)temc[i]=tema[i]+temb[i];</span><br><span class="line"><span class="comment">//    cout&lt;&lt;"?????\n";</span></span><br><span class="line">    MPI_Send(temc,sub_size,MPI_INT,<span class="number">0</span>,myid,MPI_COMM_WORLD);</span><br><span class="line">  &#125;</span><br><span class="line">  MPI_Finalize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

分别对线程数量为3,5,6,9,11(即将数组分为2,4,5,8,10份)进行了实验，结果如下：

![image.png](https://i.loli.net/2020/03/02/e4tHBE5ODVrqAh3.png)

可以发现消耗的时间比前面用并行指令集多很多，这应该是因为线程之间通信次数很多，消耗了很多时间，而本身要计算的任务并不复杂，因此多线程的优势并不能得以发挥。

再使用OpenMP来进行多线程计算，这只需将串行的代码稍作修改即可。
代码如下：

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sttoi</span><span class="params">(<span class="keyword">char</span>* s)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ret=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;s[i]!=<span class="string">'\0'</span>;i++)&#123;</span><br><span class="line">    ret*=<span class="number">10</span>;</span><br><span class="line">    ret+=s[i]<span class="number">-48</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX=<span class="number">1e6</span>;</span><br><span class="line"><span class="keyword">int</span> a[MAX],b[MAX],c[MAX];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>** argv)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num=sttoi(argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">begin</span>,<span class="title">end</span>;</span></span><br><span class="line">  gettimeofday(&amp;begin ,<span class="literal">NULL</span>);</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for num_threads(num)</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;MAX;i++)c[i]=a[i]+b[i];</span><br><span class="line">  gettimeofday(&amp;end ,<span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>,end.tv_sec*<span class="number">1000000</span>+end.tv_usec-begin.tv_sec*<span class="number">1000000</span>-begin.tv_usec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

对线程数分别为1-11做了5次实验，分别取平均值，绘图如下:
运行结果如下：
![image.png](https://i.loli.net/2020/03/12/dpemj3nNCBYA146.png)
可以看到当线程数为4时，运行时间最短，大概是1500μs，当线程数增多时，运行时间变化并不规律。
绘制对应的加速比图像如下:
![image.png](https://i.loli.net/2020/03/12/6pNoCGa2KUWqEhT.png)
当线程数为4时，加速比大概是2.3，略强于用并行指令集的情况。

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/openmp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/11/openmp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">openmp学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-11 14:03:51 / 修改时间：22:27:00" itemprop="dateCreated datePublished" datetime="2020-03-11T14:03:51+08:00">2020-03-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
# openmp学习笔记

主要参考这两篇博客:
<https://blog.csdn.net/ArrowYL/article/details/81094837>
<https://blog.csdn.net/YUNXIN221/article/details/103964460>
在此向两位博主表示感谢。

## 几种常用的子句

openmp 指令一般以 #pragma omp 开头,后面接其他的子句。常用子句有:

### parallel

用于指定接下来的代码块被并行执行，如
![image.png](https://i.loli.net/2020/03/11/besO4RPr27iI8f6.png)
但如果把大括号去掉，则只有第一句被并行执行:
![image.png](https://i.loli.net/2020/03/11/eEFXiGguhsDRa3N.png)

### for

for子句一般与parallel一起用，可以使一段for循环被分配到多线程处理。注意，用户需要保证for循环中没有数据依赖问题，否则会得到错误结果。
正确示范:
![image.png](https://i.loli.net/2020/03/11/SNUovmHKAc8eDrs.png)

错误示范:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fib[<span class="number">101</span>]=&#123;<span class="number">1</span>,<span class="number">1</span>&#125;;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">20</span>;i++)fib[i]=fib[i<span class="number">-1</span>]+fib[i<span class="number">-2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">20</span>;i++)<span class="built_in">printf</span>(<span class="string">"%d "</span>,fib[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

结果为
![image.png](https://i.loli.net/2020/03/11/9AEN8UZJCh1lpik.png)
可以看到,只有前几项是正确的结果，后面的数都是0,这是因为openmp将for循环分给多个线程执行,后面的线程执行的时候fib[i-1]和fib[i-2]还没被算出来。

此外，需注意的是使用for子句还对for循环有很多要求:
1/循环的变量变量（就是i）必须是整形，其他的(double等)都不行。
2.循环的比较条件必须是< <= > >=中的一种
3.循环的增量部分必须是增减一个不变的值（即每次循环是不变的）。
4.如果比较符号是< <=，那每次循环i应该增加，反之应该减小
5.循环必须是没有奇奇怪怪的东西，不能从内部循环跳到外部循环，goto和break只能在循环内部跳转，异常必须在循环内部被捕获。

### sections和section

sections 子句将每个section分给一个线程执行，不同section之间是并行的。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel sections<span class="comment">//注意这里一定要换行不然会报错</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;<span class="comment">//这里也要换行</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"section 1 threadid=%d\n"</span>,omp_get_thread_num());</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"kjaenknfe\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"section 3 threadid=%d\n"</span>,omp_get_thread_num());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"section 4 threadid=%d\n"</span>,omp_get_thread_num());  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### private,firstprivate,lastprivate

private(x)子句为每个线程声明一个私有变量x，不同线程的x之间没有联系，即使前面的程序中有x这个变量也不会干扰。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x=<span class="number">100</span>;</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel private(x)</span></span><br><span class="line">  &#123;</span><br><span class="line">    x=omp_get_thread_num();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"In thread %d,x=%d\n"</span>,omp_get_thread_num(),x);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

运行结果:
![image.png](https://i.loli.net/2020/03/11/1WIVObn7YHBd8XU.png)
firstprivate(x)子句使子线程的x继承主线程中的x值,不同线程之间的x没有联系,而子线程中改变x的值并不会导致主线程中的x的值改变。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x=<span class="number">100</span>;</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel firstprivate(x)</span></span><br><span class="line">  &#123;</span><br><span class="line">    x+=omp_get_thread_num();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"In thread %d,x=%d\n"</span>,omp_get_thread_num(),x);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

运行结果:
![image.png](https://i.loli.net/2020/03/11/1WIVObn7YHBd8XU.png)
lastprivate(x)子句的作用与firstprivate相反，它为每个子线程中声明变量x，但x并不继承主程序中x的值。当子线程结束之后，把子线程的x的值赋给主线程中的x。

在for循环中使用lastprivate:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x=<span class="number">100</span>;</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for firstprivate(x),lastprivate(x)</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">      x+=i;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>,omp_get_thread_num(),x);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

注意，如果是在for循环中使用lastprivate(x)，则会将最后一个线程的x的最终值赋给主变量中的x。这里的最后一个线程指的是逻辑上的最后一个，而不是最后一个结束的，如这里线程号为11的线程是最后一个，它的x的值最终是119，所以把119赋给主程序中的x。

![image.png](https://i.loli.net/2020/03/11/iQYW82pEv3VL1fH.png)

在sections中使用lastprivate:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> x=<span class="number">100</span>;</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel sections lastprivate(x)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">      x=omp_get_thread_num();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"section 1:x=%d\n"</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">      x=omp_get_thread_num();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"section 2:x=%d\n"</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">      x=omp_get_thread_num();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"section 3:x=%d\n"</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> omp section</span></span><br><span class="line">    &#123;</span><br><span class="line">      x=omp_get_thread_num();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"section 4:x=%d\n"</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"x="</span>&lt;&lt;x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

而如果是在sections里使用,则会把最后一个section的x赋值回去。
![image.png](https://i.loli.net/2020/03/11/4bous52hvGQnXFw.png)

### threadprivate

threadprivate(x)将x(一般是全局变量)复制到各个子线程，在其他线程中修改x的值不会影响主程序中x的值，但第0个线程中修改x的值会导致主程序中x的值一并修改。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> global_x = <span class="number">10</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp threadprivate(global_x)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">  global_x=i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"in thread%d: %d\n"</span>,omp_get_thread_num(),global_x);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;<span class="string">"In main thread: "</span>&lt;&lt;global_x&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

运行结果：
![image.png](https://i.loli.net/2020/03/11/L7F9v5nJyb8mj6B.png)

### copyin

copyin(x)等于把threadprivate变量x全局变量广播一遍，让所有线程的x值与主进程相同。

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> A=<span class="number">100</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp threadprivate(A)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">omp_set_dynamic(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">  A=i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"The value of A in thread without copyin %d: %d\n"</span>,omp_get_thread_num(),A);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> omp parallel copyin(A)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"The value of A in thread %d: %d\n"</span>,omp_get_thread_num(),A);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

运行结果:
![image.png](https://i.loli.net/2020/03/11/A3b75vxRLMZIFha.png)

## openmp中的任务调度问题

对于一个for循环，编译器要考虑将不同的部分调度给不同的线程执行。默认情况下openmp大多采用静态调度方法，即假设循环需要进行n次,有k个线程，则前$n\%k$个线程执行 $\left\lceil\dfrac{n}{k}\right\rceil$次,后$n-n\%k$个线程执行$\left\lfloor\dfrac{n}{k}\right\rfloor$次。

OpenMP提供了schedule子句来实现任务的调度。schedule子句格式：schedule(type,[size])。

　　参数type是指调度的类型，可以取值为static，dynamic，guided，runtime四种值。其中runtime允许在运行时确定调度类型，因此实际调度策略只有前面三种。

1 静态调度static
如果参数[size]为空，则采用默认的调度方式;否则将循环的前size次由第一个线程执行，size+1 —— 2*size 次由第二个线程执行……第(k-1)*size+1——k\*size次由第k个线程执行。如果k\*size<n，则再分配size次给第一个线程、分配size个给第二个线程……

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for schedule(static,3)</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50</span>;i++)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d: Thread %d\n"</span>,i,omp_get_thread_num());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

运行结果:
![image.png](https://i.loli.net/2020/03/11/MCRYrqjWoINFJlz.png)

2 动态调度dynamic
动态调度依赖于运行时的状态动态确定线程所执行的迭代，也就是线程执行完已经分配的任务后，会去领取还有的任务（与静态调度最大的不同，每个线程完成的任务数量可能不一样）。由于线程启动和执行完的时间不确定，所以迭代被分配到哪个线程是无法事先知道的。

　　当不使用size 时，是将迭代逐个地分配到各个线程。当使用size 时，逐个分配size个迭代给各个线程，这个用法类似静态调度。

3 启发式调度guided
 　　采用启发式调度方法进行调度，每次分配给线程迭代次数不同，开始比较大，以后逐渐减小。开始时每个线程会分配到较大的迭代块，之后分配到的迭代块会逐渐递减。迭代块的大小会按指数级下降到指定的size大小，如果没有指定size参数，那么迭代块大小最小会降到1。

　　size表示每次分配的迭代次数的最小值，由于每次分配的迭代次数会逐渐减少，少到size时，将不再减少。具体采用哪一种启发式算法，需要参考具体的编译器和相关手册的信息。

## 一点小建议

尽量不要用在并行执行的程序块里cout。原因很简单，比如cout<<a<<b,可能第一个线程刚输出了a还没输出b，第二个线程由输出了a，就乱套了，比如下面的例子:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)<span class="built_in">cout</span>&lt;&lt;<span class="string">"Thread:"</span>&lt;&lt;omp_get_thread_num()&lt;&lt;<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

![image.png](https://i.loli.net/2020/03/11/Yt3jJ8muiwck7We.png)

但如果是使用printf就这个问题:
![image.png](https://i.loli.net/2020/03/11/vesrBXNMtDYklVi.png)

如果要统计一段openmp并行化的程序的运行时间，不要用clock()函数。这是因为clock()得到的是cpu时间，会把多个核的时间加在一起;而我们想要的一般是现实中经过的时间，所以要用omp_get_wtime()函数。
举个例子:

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">int</span> x;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">300000000</span>;i++);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> t1=omp_get_wtime();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">12</span>;i++)f();</span><br><span class="line">  <span class="keyword">double</span> t2=omp_get_wtime();</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;t2-t1&lt;&lt;<span class="string">"s\n"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> t3=clock();</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">pragma</span> omp parallel for</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">12</span>;i++)f();</span><br><span class="line">  <span class="keyword">double</span> t4=clock();</span><br><span class="line">  <span class="built_in">cout</span>&lt;&lt;(t4-t3)/<span class="number">1e6</span>&lt;&lt;<span class="string">"s\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

结果如下：
![image.png](https://i.loli.net/2020/03/11/MSaNuED2nRJBQVW.png)
用clock()统计出来的时间有6.9s，但事实上程序运行的时间不到2s。openmp在我的电脑上默认使用12线程，所以大概是clock()函数会把每个线程的时间都加起来。

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AE%9E%E9%AA%8C1_Echo%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%AE%9E%E9%AA%8C1_Echo%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">计算机网络实验1_Echo实验</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-04T00:00:00+08:00">2020-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-05 19:56:46" itemprop="dateModified" datetime="2020-03-05T19:56:46+08:00">2020-03-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          # 计算机网络实验1_Echo实验

## 1.编写TCP Echo程序

&#8195;&#8195;客户端向服务器发送一个字符串，服务器收到后向字符串里添加当前的时间，再发送回客户端。

### 客户端程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFLEN          2000               <span class="comment">// 缓冲区大小</span></span></span><br><span class="line"><span class="comment">/*------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * main - TCP client for TIME service</span></span><br><span class="line"><span class="comment"> *------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">char</span>    *host = <span class="string">"127.0.0.1"</span>;        <span class="comment">/* server IP to connect本地IP         */</span></span><br><span class="line">        <span class="keyword">char</span>    *service = <span class="string">"50500"</span>;         <span class="comment">/* server port to connect 端口号     */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span>             <span class="comment">/* an Internet endpoint address */</span></span><br><span class="line">        <span class="keyword">char</span>    buf[BUFLEN+<span class="number">1</span>];              <span class="comment">/* buffer for one line of text  */</span></span><br><span class="line">        <span class="keyword">int</span>     sock;                       <span class="comment">/* socket descriptor            */</span></span><br><span class="line">        <span class="keyword">int</span>     cc;                         <span class="comment">/* recv character count         */</span></span><br><span class="line"></span><br><span class="line">        sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);   <span class="comment">//创建套接字，参数：因特网协议簇(family)，流套接字，TCP协议</span></span><br><span class="line">        <span class="comment">//返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));        <span class="comment">// 从&amp;sin开始的长度为sizeof(sin)的内存清0</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_family = AF_INET;            <span class="comment">// 因特网地址簇</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_addr.s_addr = inet_addr(host); <span class="comment">//  printf("%d\n",sin.sin_addr.s_addr);        // 设置服务器IP地址(32位)</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_port = htons((<span class="keyword">unsigned</span> short)atoi(service));        <span class="comment">// 设置服务器端口号</span></span><br><span class="line">        <span class="keyword">int</span> ret=connect(sock, (struct sockaddr *)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>)); <span class="comment">// 连接到服务器，第二个参数指向存放服务器地址的结构，第三个参数为该结构的大小，返回值为0时表示无错误发生，</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"请输入要发送的消息:"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">        <span class="keyword">int</span> c1=send(sock,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">        cc = recv(sock, buf, BUFLEN, <span class="number">0</span>);    <span class="comment">// 第二个参数指向缓冲区，第三个参数为缓冲区大小(字节数)，第四个参数一般设置为0，返回值:(&gt;0)接收到的字节数,(=0)对方已关闭,(&lt;0)连接出错</span></span><br><span class="line">        <span class="keyword">if</span>(cc&lt;=<span class="number">0</span>)</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Error!\n"</span>); <span class="comment">//出错或对方关闭(==0)。其后必须关闭套接字sock。</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(cc &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           buf[cc] = <span class="string">'\0'</span>;          <span class="comment">// ensure null-termination</span></span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"\n客户端：\n收到的消息:%s\n"</span>,buf);                   <span class="comment">// 显示所接收的字符串</span></span><br><span class="line">        &#125;</span><br><span class="line">        close(sock);           <span class="comment">// 关闭监听套接字</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"按回车键继续..."</span>);</span><br><span class="line">        getchar();              <span class="comment">// 等待任意按键</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 服务器程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* server2.c */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"><span class="comment">/* argc: 命令行参数个数， 例如：C:\&gt; TCPServer 8080</span></span></span><br><span class="line"><span class="function"><span class="comment">                     argc=2 argv[0]="TCPServer",argv[1]="8080" */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">fsin</span>;</span> <span class="comment">/* the from address of a client       */</span></span><br><span class="line">     <span class="keyword">int</span> msock, ssock;        <span class="comment">/* master &amp; slave sockets         */</span></span><br><span class="line">     <span class="keyword">char</span> *service = <span class="string">"50500"</span>;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span> <span class="comment">/* an Internet endpoint address             */</span></span><br><span class="line">     <span class="keyword">int</span> alen;               <span class="comment">/* from-address length                      */</span></span><br><span class="line">     <span class="keyword">char</span> pts[<span class="number">1000</span>];         <span class="comment">/* pointer to time string           */</span></span><br><span class="line">     <span class="keyword">time_t</span> now;             <span class="comment">/* current time                                 */</span></span><br><span class="line"></span><br><span class="line">     msock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">// 创建套接字，参数：因特网协议簇(family)，流套接字，TCP协议</span></span><br><span class="line">                                                        <span class="comment">// 返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line"></span><br><span class="line">     <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));                     <span class="comment">// 从&amp;sin开始的长度为sizeof(sin)的内存清0</span></span><br><span class="line">     <span class="built_in">sin</span>.sin_family = AF_INET;                            <span class="comment">// 因特网地址簇(INET-Internet)</span></span><br><span class="line">     <span class="built_in">sin</span>.sin_addr.s_addr = INADDR_ANY;                    <span class="comment">// 监听所有(接口的)IP地址。</span></span><br><span class="line">     <span class="built_in">sin</span>.sin_port = htons((<span class="keyword">unsigned</span> short)atoi(service)); <span class="comment">// 监听的端口号。atoi--把ascii转化为int，htons--主机序到网络序(host to network，s-short 16位)</span></span><br><span class="line">     bind(msock, (struct sockaddr *)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));   <span class="comment">// 绑定监听的IP地址和端口号</span></span><br><span class="line"></span><br><span class="line">     listen(msock, <span class="number">5</span>); <span class="comment">// 建立长度为5的连接请求队列，并把到来的连接请求加入队列等待处理。</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">     &#123;                                                                         <span class="comment">// 检测是否有按键,如果没有则进入循环体执行</span></span><br><span class="line">          alen = <span class="keyword">sizeof</span>(struct sockaddr);                                      <span class="comment">// 取到地址结构的长度</span></span><br><span class="line">          ssock = accept(msock, (struct sockaddr *)&amp;fsin, (<span class="keyword">socklen_t</span> *)&amp;alen); <span class="comment">// 如果在连接请求队列中有连接请求，则接受连接请求并建立连接，返回该连接的套接字，否则，本语句被阻塞直到队列非空。fsin包含客户端IP地址和端口号</span></span><br><span class="line">          <span class="keyword">time_t</span> t = time(<span class="literal">NULL</span>);</span><br><span class="line">          <span class="keyword">char</span> ch[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">          <span class="keyword">char</span> result[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">          strftime(ch, <span class="keyword">sizeof</span>(ch) - <span class="number">1</span>, <span class="string">"%Y-%m-%d--%H:%M:%S\n"</span>, localtime(&amp;t));</span><br><span class="line">          <span class="keyword">int</span> c1 = <span class="built_in">sprintf</span>(pts, <span class="string">"%s"</span>,ch);</span><br><span class="line">          <span class="keyword">int</span> c2 = recv(ssock, pts + c1, <span class="number">1000</span>, <span class="number">0</span>);</span><br><span class="line">          pts[c1 + c2] = <span class="string">'\0'</span>;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"\n服务器端:\n收到消息:%s\n收到消息的时间:%s"</span>, pts + c1,ch);</span><br><span class="line">          <span class="keyword">int</span> cc = send(ssock, pts, <span class="built_in">strlen</span>(pts), <span class="number">0</span>); <span class="comment">// 第二个参数指向发送缓冲区，第三个参数为要发送的字节数，第四个参数一般置0，返回值为实际发送的字节数，出错或对方关闭时返回SOCKET_ERROR。</span></span><br><span class="line">          <span class="comment">//     printf("%s", pts);  // 显示发送的字符串</span></span><br><span class="line">          close(ssock);          <span class="comment">// 关闭连接套接字</span></span><br><span class="line">     &#125;</span><br><span class="line">     close(msock); <span class="comment">// 关闭监听套接字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 效果展示

客户端
![image.png](https://i.loli.net/2020/03/04/2Wc7viDUrfTubZq.png)
![image.png](https://i.loli.net/2020/03/04/VWoMvUnlh5RIzfi.png)

服务器
![image.png](https://i.loli.net/2020/03/04/XNTuIi8G1AEdHzk.png)

## 2.编写TCP echo增强程序

&#8195;&#8195;服务器在收到客户端的消息时显示服务器的当前时间、客户端的IP地址、客户端的端口号和客户端发来的信息，并把它们一并返回给客户端。
&#8195;&#8195;客户端在发送消息后把服务器发回给它的消息显示出来。客户端程序与(1)同，不用修改
&#8195;&#8195;要求服务器直接从accept()的参数fsin中得到客户端的IP地址和端口号。注：服务器获取IP地址后要求直接使用s_un_b的四个分量得到IP地址，不能使用函数inet_ntoa()转换IP地址。

### 客户端程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* client2.c */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;error.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFLEN          2000                  			<span class="comment">// 缓冲区大小</span></span></span><br><span class="line"><span class="comment">/*------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * main - TCP client for TIME service</span></span><br><span class="line"><span class="comment"> *------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">char</span>    *host = <span class="string">"127.0.0.1"</span>; <span class="comment">/* server IP to connect         */</span></span><br><span class="line">        <span class="keyword">char</span>    *service = <span class="string">"50500"</span>;  <span class="comment">/* server port to connect       */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span>      <span class="comment">/* an Internet endpoint address */</span></span><br><span class="line">        <span class="keyword">char</span>    buf[BUFLEN+<span class="number">1</span>];       <span class="comment">/* buffer for one line of text  */</span></span><br><span class="line">        <span class="keyword">int</span>     sock;                <span class="comment">/* socket descriptor            */</span></span><br><span class="line">        <span class="keyword">int</span>     cc;                   <span class="comment">/* recv character count         */</span></span><br><span class="line"></span><br><span class="line">        sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);    	<span class="comment">//创建套接字，参数：因特网协议簇(family)，流套接字，TCP协议</span></span><br><span class="line">        <span class="comment">//返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));<span class="comment">// 从&amp;sin开始的长度为sizeof(sin)的内存清0</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_family = AF_INET;            <span class="comment">// 因特网地址簇</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_addr.s_addr = inet_addr(host); <span class="comment">//  printf("%d\n",sin.sin_addr.s_addr);  // 设置服务器IP地址(32位)</span></span><br><span class="line">        <span class="built_in">sin</span>.sin_port = htons((<span class="keyword">unsigned</span> short)atoi(service));         <span class="comment">// 设置服务器端口号</span></span><br><span class="line">        <span class="keyword">int</span> ret=connect(sock, (struct sockaddr *)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));  <span class="comment">// 连接到服务器，第二个参数指向存放服务器地址的结构，第三个参数为该结构的大小，返回值为0时表示无错误发生，</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"请输入要发送的消息:"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">        <span class="keyword">int</span> c1=send(sock,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">        cc = recv(sock, buf, BUFLEN, <span class="number">0</span>);    <span class="comment">// 第二个参数指向缓冲区，第三个参数为缓冲区大小(字节数)，第四个参数一般设置为0，返回值:(&gt;0)接收到的字节数,(=0)对方已关闭,(&lt;0)连接出错</span></span><br><span class="line">        <span class="keyword">if</span>(cc&lt;=<span class="number">0</span>)</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Error!\n"</span>); <span class="comment">//出错或对方关闭(==0)。其后必须关闭套接字sock。</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(cc &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           buf[cc] = <span class="string">'\0'</span>;   <span class="comment">// ensure null-termination</span></span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"\n客户端：\n收到的消息:%s\n"</span>,buf);   <span class="comment">// 显示所接收的字符串</span></span><br><span class="line">        &#125;</span><br><span class="line">        close(sock);               <span class="comment">// 关闭监听套接字</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"按回车键继续..."</span>);</span><br><span class="line">        getchar();         <span class="comment">// 等待任意按键</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 服务器程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"><span class="comment">/* argc: 命令行参数个数， 例如：C:\&gt; TCPServer 8080</span></span></span><br><span class="line"><span class="function"><span class="comment">                     argc=2 argv[0]="TCPServer",argv[1]="8080" */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">fsin</span>;</span> <span class="comment">/* the from address of a client       */</span></span><br><span class="line">  <span class="keyword">int</span> msock, ssock;        <span class="comment">/* master &amp; slave sockets         */</span></span><br><span class="line">  <span class="keyword">char</span> *service = <span class="string">"50500"</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span> <span class="comment">/* an Internet endpoint address             */</span></span><br><span class="line">  <span class="keyword">int</span> alen;               <span class="comment">/* from-address length                      */</span></span><br><span class="line">  <span class="keyword">char</span> pts[<span class="number">1000</span>];         <span class="comment">/* pointer to time string           */</span></span><br><span class="line">  <span class="keyword">time_t</span> now;             <span class="comment">/* current time                                 */</span></span><br><span class="line"></span><br><span class="line">  msock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">// 创建套接字，参数：因特网协议簇(family)，流套接字，TCP协议</span></span><br><span class="line">   <span class="comment">// 返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));                     <span class="comment">// 从&amp;sin开始的长度为sizeof(sin)的内存清0</span></span><br><span class="line">  <span class="built_in">sin</span>.sin_family = AF_INET;                            <span class="comment">// 因特网地址簇(INET-Internet)</span></span><br><span class="line">  <span class="built_in">sin</span>.sin_addr.s_addr = INADDR_ANY;                    <span class="comment">// 监听所有(接口的)IP地址。</span></span><br><span class="line">  <span class="built_in">sin</span>.sin_port = htons((<span class="keyword">unsigned</span> short)atoi(service)); <span class="comment">// 监听的端口号。atoi--把ascii转化为int，htons--主机序到网络序(host to network，s-short 16位)</span></span><br><span class="line">  bind(msock, (struct sockaddr *)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));   <span class="comment">// 绑定监听的IP地址和端口号</span></span><br><span class="line"></span><br><span class="line">  listen(msock, <span class="number">5</span>); <span class="comment">// 建立长度为5的连接请求队列，并把到来的连接请求加入队列等待处理。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;                                                                      <span class="comment">// 检测是否有按键,如果没有则进入循环体执行</span></span><br><span class="line">    alen = <span class="keyword">sizeof</span>(struct sockaddr);                                      <span class="comment">// 取到地址结构的长度</span></span><br><span class="line">    ssock = accept(msock, (struct sockaddr *)&amp;fsin, (<span class="keyword">socklen_t</span> *)&amp;alen); <span class="comment">// 如果在连接请求队列中有连接请求，则接受连接请求并建立连接，返回该连接的套接字，否则，本语句被阻塞直到队列非空。fsin包含客户端IP地址和端口号</span></span><br><span class="line">    <span class="keyword">time_t</span> t = time(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">char</span> ch[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> result[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    strftime(ch, <span class="keyword">sizeof</span>(ch) - <span class="number">1</span>, <span class="string">"%Y-%m-%d %H:%M:%S\n"</span>, localtime(&amp;t));</span><br><span class="line">    <span class="built_in">memset</span>(pts,<span class="number">0</span>,<span class="keyword">sizeof</span>(pts));</span><br><span class="line">    <span class="keyword">int</span> c1 = recv(ssock, pts, <span class="number">1000</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">/*  int c1 = sprintf(pts + c2, "\n%s", fsin.sin_port,</span></span><br><span class="line"><span class="comment">                     fsin.sin_addr.S_un.S_un_b.s_b1,</span></span><br><span class="line"><span class="comment">                     fsin.sin_addr.S_un.S_un_b.s_b2,</span></span><br><span class="line"><span class="comment">                     fsin.sin_addr.S_un.S_un_b.s_b3,</span></span><br><span class="line"><span class="comment">                     fsin.sin_addr.S_un.S_un_b.s_b4,</span></span><br><span class="line"><span class="comment">    );*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tem=fsin.sin_addr.s_addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"收到消息: %s\n收到时间: %s客户端IP地址: %d.%d.%d.%d\n 客户端端口号:%d\n"</span></span><br><span class="line">    ,pts,ch,(tem&lt;&lt;<span class="number">24</span>)&gt;&gt;<span class="number">24</span>,(tem&lt;&lt;<span class="number">16</span>)&gt;&gt;<span class="number">24</span>,(tem&lt;&lt;<span class="number">8</span>)&gt;&gt;<span class="number">24</span>,tem&gt;&gt;<span class="number">24</span>,fsin.sin_port);</span><br><span class="line">    <span class="keyword">char</span> tempts[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(tempts,pts);</span><br><span class="line">    tempts[<span class="built_in">strlen</span>(pts)]=<span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(pts,<span class="string">"\n内容: %s\n时间: %s客户端IP地址: %d.%d.%d.%d\n客户端端口号: %d\n"</span>,</span><br><span class="line">    tempts,ch,(tem&lt;&lt;<span class="number">24</span>)&gt;&gt;<span class="number">24</span>,(tem&lt;&lt;<span class="number">16</span>)&gt;&gt;<span class="number">24</span>,(tem&lt;&lt;<span class="number">8</span>)&gt;&gt;<span class="number">24</span>,tem&gt;&gt;<span class="number">24</span>,fsin.sin_port);</span><br><span class="line">  <span class="comment">//  pts[c1 + c2] = '\0';</span></span><br><span class="line"><span class="comment">//    printf("\n服务器端:\n收到消息:%s\n收到消息的时间:%s", pts + c1, ch);</span></span><br><span class="line">    <span class="keyword">int</span> cc = send(ssock, pts, <span class="built_in">strlen</span>(pts), <span class="number">0</span>); <span class="comment">// 第二个参数指向发送缓冲区，第三个参数为要发送的字节数，第四个参数一般置0，返回值为实际发送的字节数，出错或对方关闭时返回SOCKET_ERROR。</span></span><br><span class="line">  &#125;</span><br><span class="line">  close(msock); <span class="comment">// 关闭监听套接字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 效果展示

客户端程序：
![asf.png](https://i.loli.net/2020/03/05/zw5VoBlxF3AN9Hc.png)

服务器程序：
![ang.png](https://i.loli.net/2020/03/05/Gsn3aWyDB4P27op.png)

## 3.编写UDP Echo增强程序
　　
&#8195;&#8195;完成Echo功能，即当客户端发来消息时，服务器显示出服务器的当前时间、客户端的IP、客户端的端口号和客户发来的信息，并把它们一并发回给客户端，客户端然后把它们显示出来。
&#8195;&#8195;服务器可以直接从recvfrom()的参数from中得到客户端的IP地址和端口号，并且服务器用sendto()发回给客户端消息时可以直接用该参数from作为参数toAddr。可以使用inet_ntoa()转换客户端IP地址。
&#8195;&#8195;客户端程序的recvfrom()可以直接使用原来sendto使用的sock。该sock已经绑定了客户端的IP地址和端口号，客户端可以直接用来接收数据。

## 客户端程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_IP <span class="meta-string">"127.0.0.1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_PORT <span class="meta-string">"54321"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local</span>;</span></span><br><span class="line">    local.sin_family = AF_INET;</span><br><span class="line">    local.sin_port = htons(atoi(DEFAULT_PORT));</span><br><span class="line">    local.sin_addr.s_addr = inet_addr(DEFAULT_IP);</span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(local);</span><br><span class="line">    <span class="keyword">int</span> sock = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"输入消息:\n"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">    <span class="keyword">int</span> s1 = sendto(sock, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>, (struct sockaddr *)&amp;local, len);</span><br><span class="line">    <span class="keyword">int</span> r = recvfrom(sock, buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="number">0</span>, (struct sockaddr *)&amp;local, &amp;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n "</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"按任意键退出:\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

## 服务器程序

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_IP <span class="meta-string">"127.0.0.1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_PORT <span class="meta-string">"54321"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sock = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local</span>;</span></span><br><span class="line">        local.sin_family = AF_INET;</span><br><span class="line">        local.sin_port = htons(atoi(DEFAULT_PORT));</span><br><span class="line">        local.sin_addr.s_addr = inet_addr(DEFAULT_IP);</span><br><span class="line">        bind(sock, (struct sockaddr *)&amp;local, <span class="keyword">sizeof</span>(local));</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(client);</span><br><span class="line">                <span class="comment">//  printf("get a new client ,%s:%d\n",inet_ntoa(client.sin_addr),ntohs(client.sin_port));</span></span><br><span class="line">                <span class="keyword">int</span> r = recvfrom(sock, buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="number">0</span>, (struct sockaddr *)&amp;client, &amp;len);</span><br><span class="line">                <span class="comment">//                puts("??");</span></span><br><span class="line">                <span class="keyword">time_t</span> t = time(<span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">char</span> ch[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                strftime(ch, <span class="keyword">sizeof</span>(ch) - <span class="number">1</span>, <span class="string">"%Y-%m-%d %H:%M:%S\n"</span>, localtime(&amp;t));</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">int</span> tem = client.sin_addr.s_addr;</span><br><span class="line">                <span class="keyword">char</span> tempts[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">strcpy</span>(tempts, buf);</span><br><span class="line">                <span class="comment">//            printf("%d\n",strlen(buf));</span></span><br><span class="line">                tempts[<span class="built_in">strlen</span>(buf)] = <span class="string">'\0'</span>;</span><br><span class="line">                r = <span class="built_in">sprintf</span>(buf, <span class="string">"\n客户端的消息: %s\n客户端IP地址: %d.%d.%d.%d\n时间: %s客户端端口号: %d\n"</span>,</span><br><span class="line">                            tempts, (tem &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>, (tem &lt;&lt; <span class="number">16</span>) &gt;&gt; <span class="number">24</span>, (tem &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">24</span>, tem &gt;&gt; <span class="number">24</span>, ch, client.sin_port);</span><br><span class="line">                <span class="comment">//              puts("??");</span></span><br><span class="line">                buf[r] = <span class="string">'\0'</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">                <span class="keyword">int</span> s = sendto(sock, buf, r, <span class="number">0</span>, (struct sockaddr *)&amp;client, len);</span><br><span class="line">                <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### 效果展示

客户端程序
![aw.png](https://i.loli.net/2020/03/05/NuCTfvgXFp7Qm9r.png)

服务器程序
![gweew.png](https://i.loli.net/2020/03/05/amzH6jEPlF5DQGR.png)

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/02/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E7%AC%94%E8%AE%B01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/02/%E5%B9%B6%E8%A1%8C%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97%E7%AC%94%E8%AE%B01/" class="post-title-link" itemprop="url">并行与分布式计算笔记1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-02 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-02T00:00:00+08:00">2020-03-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-04 20:48:56" itemprop="dateModified" datetime="2020-04-04T20:48:56+08:00">2020-04-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
# 并行与分布式计算笔记1

计算节点用InfiniBand网络进行通信,传输速率可以到100GB/s。

并行编译器只能做到执行级的并行，检测到basic block和少量的嵌入的for循环，无法满足并行计算的要求。
所以需要让程序员来编写并行程序。

通过操作系统底层的线程库来编程会非常复杂，甚至出错，所以会有并行编程的工具来进行抽象。

常见的工具有：
OpenMP
Message Passing InterfaceMPI(mpi)
Posix Threads(pthreads)
Open Computing Language(opencl)
CUDA
Map Reduce

## 并行编程的难点

1找到尽可能多的并行点
2粒度：函数级并行、线程级并行还是进程级并行
3局部性：并行化后是否能够利用局部数据等
4负载均衡：不同线程、不同core之间的负载分布
5协作与同步
6性能模型

## 任务并行

将一个问题划分成多个不同的子任务在不同的core上运行；
(计算密集型，可以拆分成不同的子任务)

## 数据并行

1.将问题所涉及的数据才分到不同的core上执行；
2.每个core运行的是相同的程序。
(数据密集型，大数据应用)

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/%E5%9C%A8WSL%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEVSCode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="reeeeeeeeeein">
      <meta itemprop="description" content="SYSU 计算机专业大二在读">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="reeeeeeeeeein的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/%E5%9C%A8WSL%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEVSCode/" class="post-title-link" itemprop="url">在WSL安装并配置VSCode</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-28 00:12:03" itemprop="dateCreated datePublished" datetime="2020-02-28T00:12:03+08:00">2020-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-17 17:57:06" itemprop="dateModified" datetime="2020-04-17T17:57:06+08:00">2020-04-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
## 下载WSL

WSL(Windows Subsystem for Linux)可以在windows中装一个Linux子系统，非常方便且易于使用。

首先在Microsoft Store中下载Ubuntu：

![image.png](https://i.loli.net/2020/02/28/DbgThwa9SveLnjl.png)

点开下载的界面会花很长时间，但下载速度很快。

下载过程中，打开Windows功能，勾选"适用于 Linux 的 Windows 子系统”:

![image.png](https://i.loli.net/2020/02/28/68owCq1MLNBmnhD.png)

然后打开下载好的Ubuntu，第一次打开要设定用户名和密码。这样，wsl就算是安装完了。

为了加快下载速度，把默认源切换成阿里源：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i s@&#x2F;archive.ubuntu.com&#x2F;@&#x2F;mirrors.aliyun.com&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br><span class="line">sudo apt update -y</span><br><span class="line">sudo apt upgrade -y</span><br></pre></td></tr></table></figure>

## 下载并配置VSCode

下载VSCode只用4条命令：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-desktop&#x2F;ubuntu-make</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install ubuntu-make</span><br><span class="line">sudo umake ide visual-studio-code</span><br></pre></td></tr></table></figure>

这样就得到一个未配置的VSCode了。
但是由于种种原因，下载下来的VSCode可能用不了。解决办法是在本地有一个能用的VSCode，然后在本地上安装Remote-WSL插件：

![image.png](https://i.loli.net/2020/02/28/QNIRjCSnKilqBzA.png)

这样就可以在wsl里用code .(注意小数点和前面的空格不能少)命令进入VSCode了。在root状态下使用这个命令会失效，
而且再切回原本的用户再使用也会失效，这时只能关闭终端重新启动。

然后要在wsl里安装g++和gdb：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gdb</span><br><span class="line">sudo apt-get install g++</span><br></pre></td></tr></table></figure>

接下来要配置开发环境，需要新建一个.vscode文件夹：
![image.png](https://i.loli.net/2020/02/28/WTpU5Yu3dF7qQ1y.png)

4个文件的内容分别是：

### c_cpp_properties.json

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Linux"</span>,</span><br><span class="line">            <span class="attr">"includePath"</span>: [],</span><br><span class="line">            <span class="attr">"defines"</span>: [<span class="string">"_DEBUG"</span>,<span class="string">"_UNICODE"</span>],</span><br><span class="line">            <span class="attr">"compilerPath"</span>: <span class="string">"/usr/bin/g++"</span>,</span><br><span class="line">            <span class="attr">"intelliSenseMode"</span>: <span class="string">"$&#123;default&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"version"</span>: <span class="number">4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### launch.json

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">  <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">  <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="attr">"configurations"</span>: [</span><br><span class="line">  </span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"g++ build and debug active file"</span>,</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"cppdbg"</span>,</span><br><span class="line">          <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">          <span class="attr">"program"</span>: <span class="string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span>,</span><br><span class="line">          <span class="attr">"args"</span>: [],</span><br><span class="line">          <span class="attr">"stopAtEntry"</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceFolder&#125;"</span>,</span><br><span class="line">          <span class="attr">"environment"</span>: [],</span><br><span class="line">          <span class="attr">"externalConsole"</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">          <span class="attr">"setupCommands"</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                  <span class="attr">"description"</span>: <span class="string">"Enable pretty-printing for gdb"</span>,</span><br><span class="line">                  <span class="attr">"text"</span>: <span class="string">"-enable-pretty-printing"</span>,</span><br><span class="line">                  <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"preLaunchTask"</span>: <span class="string">"g++ build active file"</span>,</span><br><span class="line">          <span class="attr">"miDebuggerPath"</span>: <span class="string">"/usr/bin/gdb"</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### settings.json

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"files.associations"</span>: &#123;</span><br><span class="line">    <span class="attr">"iostream"</span>: <span class="string">"cpp"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### task.json

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tasks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"shell"</span>,</span><br><span class="line">          <span class="attr">"label"</span>: <span class="string">"g++ build active file"</span>,</span><br><span class="line">          <span class="attr">"command"</span>: <span class="string">"/usr/bin/g++"</span>,</span><br><span class="line">          <span class="attr">"args"</span>: [</span><br><span class="line">              <span class="string">"-g"</span>,</span><br><span class="line">              <span class="string">"$&#123;file&#125;"</span>,</span><br><span class="line">              <span class="string">"-o"</span>,</span><br><span class="line">              <span class="string">"$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"options"</span>: &#123;</span><br><span class="line">              <span class="attr">"cwd"</span>: <span class="string">"/usr/bin"</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"2.0.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

然后就可以写一个helloworld.cpp,愉快地一键F5运行了：
但还是会在上方出现一个选择环境的提示，选C++(GDB/LLDB)
选择配置则是g++ build and debug active file

![image.png](https://i.loli.net/2020/02/28/4m8EVbNBOJLwFvx.png)

然后会在终端看到结果：

![image.png](https://i.loli.net/2020/02/28/MT9uopNYCtAelam.png)

当然，也可以在终端用g++直接编译然后运行~

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">reeeeeeeeeein</p>
  <div class="site-description" itemprop="description">SYSU 计算机专业大二在读</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">reeeeeeeeeein</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_sphere.min.js"></script>


  















  

  

  


<script type="text/javascript"
color="0,0,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
<script type="text/javascript" src="/js/src/dynamic_bg.js"></script>